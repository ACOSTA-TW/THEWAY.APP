<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE WAY - Gestão de Negócios</title>
    <!-- Carregamento do Tailwind CSS para estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carregamento do Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Carregamento das bibliotecas React e ReactDOM -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <!-- Carregamento do Babel para transpilar JSX no navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs: Importação das funções necessárias e exposição ao escopo global -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Sua configuração Firebase (fornecida pelo utilizador)
        const firebaseConfig = {
            apiKey: "AIzaSyBOKA8gTE-sT_pZmGk0vnxIveIcta4r1cU",
            authDomain: "theway-app-ca8e6.firebaseapp.com",
            projectId: "theway-app-ca8e6",
            storageBucket: "theway-app-ca8e6.firebasestorage.app",
            messagingSenderId: "624037320749",
            appId: "1:624037320749:web:57dbc62528abb0177280a4",
            measurementId: "G-72EGLY3Q4X"
        };

        // Expor a configuração e as funções do Firebase para o objeto 'window'
        // Isso permite que o código React (que é transpilado por Babel) acesse essas funções.
        window.firebaseConfig = firebaseConfig;
        window.firebaseAppId = firebaseConfig.projectId; // Define o ID do projeto para uso nos caminhos do Firestore

        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.getFirestore = getFirestore;
        window.collection = collection;
        window.doc = doc;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot;
        window.getDocs = getDocs;

        // A inicialização da aplicação Firebase será feita dentro do componente React
        // para garantir que o DOM e o ambiente React estão completamente prontos.
    </script>

    <style>
        /* Chosen Palette: The Way - Calm Harmony */
        /* Colors: #C0C9CC (Light Grey), #FFFFFF (White), #C8B89C (Beige), #212121 (Dark Black) */
        :root {
            --color-light-grey: #C0C9CC;
            --color-white: #FFFFFF;
            --color-beige: #C8B89C;
            --color-dark-black: #212121;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-white); /* Main background */
        }
        /* Custom Tailwind-like classes using CSS variables */
        .bg-primary-dark { background-color: var(--color-dark-black); }
        .text-primary-dark { color: var(--color-dark-black); }
        .bg-accent-beige { background-color: var(--color-beige); }
        .text-accent-beige { color: var(--color-beige); }
        .bg-light-grey-custom { background-color: var(--color-light-grey); }
        .text-light-grey-custom { color: var(--color-light-grey); }
        .border-light-grey-custom { border-color: var(--color-light-grey); }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 700px; /* Limita a largura máxima do gráfico */
            margin-left: auto;
            margin-right: auto;
            height: 300px; /* Altura base para gráficos */
            max-height: 400px; /* Altura máxima */
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        @media (min-width: 1024px) {
            .chart-container {
                height: 400px;
            }
        }
        /* Estilo para o modal */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
        }
        .modal-content {
            max-width: 90%;
            width: 500px;
        }
        /* Estilos para impressão */
        @media print {
            body > *:not(.print-area) {
                display: none;
            }
            .print-area {
                display: block;
                width: 100%;
                margin: 0;
                padding: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        console.log("Babel script started."); // Linha de depuração
        const { useState, useEffect, useRef, useCallback } = React;

        // Função auxiliar para envolver rótulos longos em gráficos
        const wrapLabels = (label, maxLength = 16) => {
            if (label.length <= maxLength) return label;
            const words = label.split(' ');
            let currentLine = '';
            const result = [];
            words.forEach(word => {
                if ((currentLine + word).length > maxLength) {
                    result.push(currentLine.trim());
                    currentLine = word + ' ';
                } else {
                    currentLine += word + ' ';
                }
            });
            result.push(currentLine.trim());
            return result;
        };

        // Dados simulados (Mock Data) - Agora usados como dados iniciais para o Firestore
        const initialMockData = {
            clientes: [
                { id_cliente: 'CLI-001', nome: 'João Silva', nif: '123456789', data_nascimento: '1980-05-10', email: 'joao.silva@example.com', telefone: '912345678', morada: 'Rua A, 123', tipo_cliente: 'Particular', id_comercial_responsavel: 'USER-001', data_criacao: '2023-01-15', rgpd_assinado: true, observacoes: 'Cliente antigo.', uploads: ['BI_Joao.pdf', 'IRS_Joao.pdf'] },
                { id_cliente: 'CLI-002', nome: 'Empresa XYZ Lda.', nif: '987654321', data_nascimento: '', email: 'contacto@xyz.com', telefone: '210987654', morada: 'Av. B, 456', tipo_cliente: 'Empresa', id_comercial_responsavel: 'USER-002', data_criacao: '2023-02-20', rgpd_assinado: true, observacoes: 'Potencial para grandes contratos.', uploads: ['Certidao_XYZ.pdf'] },
                { id_cliente: 'CLI-003', nome: 'Maria Fernandes', nif: '111222333', data_nascimento: '1992-11-25', email: 'maria.f@example.com', telefone: '934567890', morada: 'Largo C, 7', tipo_cliente: 'Particular', id_comercial_responsavel: 'USER-001', data_criacao: '2023-03-01', rgpd_assinado: false, observacoes: 'Aguardar RGPD.', uploads: [] },
                { id_cliente: 'CLI-004', nome: 'Global Solutions SA', nif: '444555666', data_nascimento: '', email: 'info@globalsol.com', telefone: '223456789', morada: 'Rua D, 88', tipo_cliente: 'Empresa', id_comercial_responsavel: 'USER-003', data_criacao: '2023-04-10', rgpd_assinado: true, observacoes: 'Novo cliente empresarial.', uploads: [] },
                { id_cliente: 'CLI-005', nome: 'Pedro Costa', nif: '777888999', data_nascimento: '1975-01-01', email: 'pedro.costa@example.com', telefone: '967890123', morada: 'Praceta E, 1', tipo_cliente: 'Particular', id_comercial_responsavel: 'USER-001', data_criacao: '2024-01-05', rgpd_assinado: true, observacoes: 'Renovação de seguro em breve.', uploads: [] },
            ],
            contratos: [
                { id_contrato: 'CON-001', id_cliente: 'CLI-001', id_comercial: 'USER-001', tipo_servico: 'Crédito', data_inicio: '2023-01-20', data_fim: '2028-01-20', estado: 'Ativo', observacoes: 'Crédito habitação.', data_criacao: '2023-01-18' },
                { id_contrato: 'CON-002', id_cliente: 'CLI-001', id_comercial: 'USER-001', tipo_servico: 'Seguro', data_inicio: '2023-03-01', data_fim: '2024-03-01', estado: 'Ativo', observacoes: 'Seguro automóvel.', data_criacao: '2023-02-25' },
                { id_contrato: 'CON-003', id_cliente: 'CLI-002', id_comercial: 'USER-002', tipo_servico: 'Consultoria', data_inicio: '2023-03-10', data_fim: '2023-06-10', estado: 'Fechado', observacoes: 'Consultoria financeira.', data_criacao: '2023-03-05' },
                { id_contrato: 'CON-004', id_cliente: 'CLI-003', id_comercial: 'USER-001', tipo_servico: 'Legalização', data_inicio: '2023-04-05', data_fim: '', estado: 'Pendente', observacoes: 'Legalização de viatura.', data_criacao: '2023-04-01' },
                { id_contrato: 'CON-005', id_cliente: 'CLI-004', id_comercial: 'USER-003', tipo_servico: 'Seguro', data_inicio: '2023-05-15', data_fim: '2024-05-15', estado: 'Ativo', observacoes: 'Seguro de saúde empresarial.', data_criacao: '2023-05-10' },
                { id_contrato: 'CON-006', id_cliente: 'CLI-005', id_comercial: 'USER-001', tipo_servico: 'Seguro', data_inicio: '2024-02-01', data_fim: '2025-02-01', estado: 'Ativo', observacoes: 'Seguro de vida.', data_criacao: '2024-01-28' },
                { id_contrato: 'CON-007', id_cliente: 'CLI-001', id_comercial: 'USER-001', tipo_servico: 'Crédito', data_inicio: '2024-03-01', data_fim: '2029-03-01', estado: 'Pendente', observacoes: 'Crédito automóvel.', data_criacao: '2024-02-20' },
            ],
            detalhes_credito: [
                { id_contrato: 'CON-001', id_financeira: 'FIN-001', id_fornecedor: 'FOR-001', valor_financiado: 150000, prazo_meses: 360, comissao_financeira: 1500, comissao_fornecedor: 500, documentos_em_falta: false, lista_documentos_em_falta: '', credito_realizado: true, data_realizacao: '2023-01-20' },
                { id_contrato: 'CON-007', id_financeira: 'FIN-002', id_fornecedor: 'FOR-002', valor_financiado: 25000, prazo_meses: 84, comissao_financeira: 250, comissao_fornecedor: 100, documentos_em_falta: true, lista_documentos_em_falta: 'Declaração IRS, Comprovativo Morada', credito_realizado: false, data_realizacao: '' },
            ],
            detalhes_seguro: [
                { id_contrato: 'CON-002', id_companhia: 'COMP-001', tipo_seguro: 'Automóvel', valor_premio: 350, freelancer: false, mediador: 'Mediador A', renovacao_automatica: true, data_renovacao: '2025-03-01' },
                { id_contrato: 'CON-005', id_companhia: 'COMP-002', tipo_seguro: 'Saúde', valor_premio: 1200, freelancer: false, mediador: 'Mediador B', renovacao_automatica: true, data_renovacao: '2025-05-15' },
                { id_contrato: 'CON-006', id_companhia: 'COMP-001', tipo_seguro: 'Vida', valor_premio: 200, freelancer: true, mediador: 'Mediador C', renovacao_automatica: false, data_renovacao: '2025-02-01' },
            ],
            detalhes_legalizacao_consultoria: [
                { id_contrato: 'CON-003', tipo_processo: 'Consultoria Financeira', estado_processo: 'Concluído', honorarios: 1500, documentos_necessarios: '' },
                { id_contrato: 'CON-004', tipo_processo: 'Legalização de Viatura', estado_processo: 'Em Análise', honorarios: 300, documentos_necessarios: 'Documento Único Automóvel, Fatura de Compra' },
            ],
            utilizadores: [
                { id_utilizador: 'USER-001', nome: 'Comercial Ana', email: 'ana@theway.com', role: 'Comercial' },
                { id_utilizador: 'USER-002', nome: 'Comercial Bruno', email: 'bruno@theway.com', role: 'Comercial' },
                { id_utilizador: 'USER-003', nome: 'Admin Sofia', email: 'sofia@theway.com', role: 'Admin' },
                { id_utilizador: 'USER-004', nome: 'Colaborador Carlos', email: 'carlos@theway.com', role: 'Colaborador' },
            ],
            fornecedores: [
                { id_fornecedor: 'FOR-001', nome: 'Fornecedor Crédito A', nif: '500111222', contacto: '211234567', email: 'forn.a@example.com', morada: 'Rua do Fornecedor A, 1' },
                { id_fornecedor: 'FOR-002', nome: 'Fornecedor Crédito B', nif: '500333444', contacto: '212345678', email: 'forn.b@example.com', morada: 'Avenida do Crédito B, 2' },
            ],
            financeiras: [
                { id_financeira: 'FIN-001', nome: 'Banco X', contacto: '213000111', email: 'banco.x@example.com' },
                { id_financeira: 'FIN-002', nome: 'Financeira Y', contacto: '214000222', email: 'fin.y@example.com' },
            ],
            companhias_seguros: [
                { id_companhia: 'COMP-001', nome: 'Seguradora Alfa', contacto: '215000333', email: 'alfa@example.com' },
                { id_companhia: 'COMP-002', nome: 'Seguradora Beta', contacto: '216000444', email: 'beta@example.com' },
            ],
            tarefas: [
                { id_tarefa: 'TASK-001', titulo: 'Contactar João Silva para RGPD', descricao: 'RGPD pendente para o cliente João Silva.', data_vencimento: '2024-08-15', estado: 'Pendente', prioridade: 'Alta', id_cliente: 'CLI-003', id_contrato: null, id_utilizador_responsavel: 'USER-001', data_criacao: '2024-07-20' },
                { id_tarefa: 'TASK-002', titulo: 'Verificar estado do Crédito Automóvel', descricao: 'Contrato CON-007, aguardar documentos em falta.', data_vencimento: '2024-08-01', estado: 'Pendente', prioridade: 'Média', id_cliente: 'CLI-001', id_contrato: 'CON-007', id_utilizador_responsavel: 'USER-001', data_criacao: '2024-07-25' },
                { id_tarefa: 'TASK-003', titulo: 'Renovação Seguro Pedro Costa', descricao: 'Seguro de vida CON-006 expira em 2025-02-01.', data_vencimento: '2025-01-15', estado: 'Pendente', prioridade: 'Baixa', id_cliente: 'CLI-005', id_contrato: 'CON-006', id_utilizador_responsavel: 'USER-001', data_criacao: '2024-07-28' },
            ],
            interacoes: [
                { id_interacao: 'INT-001', id_cliente: 'CLI-001', id_contrato: null, tipo_interacao: 'Chamada', data_interacao: '2024-07-20T10:30:00', observacoes: 'Chamada para agendamento de reunião sobre novo crédito.', id_utilizador: 'USER-001' },
                { id_interacao: 'INT-002', id_cliente: 'CLI-002', id_contrato: 'CON-003', tipo_interacao: 'Email', data_interacao: '2023-06-10T15:00:00', observacoes: 'Email de conclusão da consultoria financeira.', id_utilizador: 'USER-002' },
            ],
            historico_alteracoes: [], // Não simulado em detalhe para este protótipo
            uploads: [], // Simulado apenas como lista de nomes de ficheiros nos clientes
        };

        // Componente Modal
        const Modal = ({ title, message, onClose, onConfirm, showConfirm = false }) => {
            return (
                <div className="fixed inset-0 flex items-center justify-center z-50 modal-overlay">
                    <div className="bg-white p-8 rounded-xl shadow-2xl text-center modal-content">
                        <h3 className="text-2xl font-bold text-primary-dark mb-4">{title}</h3>
                        <p className="text-lg text-gray-700 mb-6">{message}</p>
                        <div className="flex justify-center space-x-4">
                            {showConfirm && (
                                <button
                                    onClick={onConfirm}
                                    className="bg-accent-beige hover:bg-primary-dark text-white font-bold py-2 px-5 rounded-lg transition duration-300 ease-in-out transform hover:scale-105"
                                >
                                    Confirmar
                                </button>
                            )}
                            <button
                                onClick={onClose}
                                className={`font-bold py-2 px-5 rounded-lg transition duration-300 ease-in-out transform hover:scale-105
                                    ${showConfirm ? 'bg-light-grey-custom hover:bg-primary-dark text-primary-dark hover:text-white' : 'bg-accent-beige hover:bg-primary-dark text-white'}`}
                            >
                                {showConfirm ? 'Cancelar' : 'OK'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Componente da Aplicação Principal
        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [currentUserRole, setCurrentUserRole] = useState('Admin'); // Simulação de role
            const [userId, setUserId] = useState(null); // ID do utilizador Firebase
            const [isAuthReady, setIsAuthReady] = useState(false); // Estado de autenticação
            const [showModal, setShowModal] = useState(false);
            const [modalContent, setModalContent] = useState({});

            // Estados para os dados do Firestore
            const [clientes, setClientes] = useState([]);
            const [contratos, setContratos] = useState([]);
            const [detalhesCredito, setDetalhesCredito] = useState([]);
            const [detalhesSeguro, setDetalhesSeguro] = useState([]);
            const [detalhesLegalizacaoConsultoria, setDetalhesLegalizacaoConsultoria] = useState([]);
            const [utilizadores, setUtilizadores] = useState([]);
            const [fornecedores, setFornecedores] = useState([]);
            const [financeiras, setFinanceiras] = useState([]);
            const [companhiasSeguros, setCompanhiasSeguros] = useState([]);
            const [tarefas, setTarefas] = useState([]); // Novo estado para tarefas
            const [interacoes, setInteracoes] = useState([]); // Novo estado para interações

            // Inicialização do Firebase e autenticação
            useEffect(() => {
                const setupFirebase = async () => {
                    console.log("Iniciando setup do Firebase..."); // Depuração

                    try {
                        // Inicializa a aplicação Firebase usando a configuração exposta globalmente
                        window.firebaseApp = window.initializeApp(window.firebaseConfig);
                        window.db = window.getFirestore(window.firebaseApp);
                        window.auth = window.getAuth(window.firebaseApp);
                        console.log("Firebase inicializado com sucesso no useEffect.");

                        // Autentica o utilizador anonimamente
                        const userCredential = await window.signInAnonymously(window.auth);
                        const currentUserId = userCredential.user.uid;
                        setUserId(currentUserId);
                        setIsAuthReady(true);
                        console.log("Autenticação Firebase concluída. User ID:", currentUserId); // Depuração

                        // Adiciona dados iniciais se as coleções estiverem vazias (apenas na primeira execução)
                        const checkAndSeedData = async (collectionName, data) => {
                            const colRef = window.collection(window.db, `artifacts/${window.firebaseAppId}/public/data/${collectionName}`);
                            const snapshot = await window.getDocs(colRef);
                            if (snapshot.empty) {
                                console.log(`Coleção ${collectionName} vazia. A semear dados iniciais...`);
                                for (const item of data) {
                                    await window.addDoc(colRef, item);
                                }
                                console.log(`Dados iniciais semeados para ${collectionName}.`);
                            } else {
                                console.log(`Coleção ${collectionName} já contém dados. Não foi necessário semear.`);
                            }
                        };

                        // Semear dados iniciais apenas se as coleções estiverem vazias
                        await checkAndSeedData('clientes', initialMockData.clientes);
                        await checkAndSeedData('contratos', initialMockData.contratos);
                        await checkAndSeedData('detalhes_credito', initialMockData.detalhes_credito);
                        await checkAndSeedData('detalhes_seguro', initialMockData.detalhes_seguro);
                        await checkAndSeedData('detalhes_legalizacao_consultoria', initialMockData.detalhes_legalizacao_consultoria);
                        await checkAndSeedData('utilizadores', initialMockData.utilizadores);
                        await checkAndSeedData('fornecedores', initialMockData.fornecedores);
                        await checkAndSeedData('financeiras', initialMockData.financeiras);
                        await checkAndSeedData('companhias_seguros', initialMockData.companhias_seguros);
                        await checkAndSeedData('tarefas', initialMockData.tarefas);
                        await checkAndSeedData('interacoes', initialMockData.interacoes);

                    } catch (error) {
                        console.error("Erro durante a inicialização/autenticação Firebase ou semeadura de dados:", error);
                        showAppModal(
                            'Erro de Inicialização/Autenticação',
                            `Ocorreu um erro ao iniciar o Firebase ou autenticar: ${error.message}. Verifique a sua ligação à internet e as regras de segurança do seu Firestore.`
                        );
                        setIsAuthReady(true); // Permite que a UI carregue mesmo com erro
                    }
                };

                setupFirebase();
            }, []); // O array de dependências vazio garante que este efeito corre apenas uma vez, no montagem do componente.

            // Listeners para dados em tempo real do Firestore
            useEffect(() => {
                if (!isAuthReady || !window.db) return; // Garante que o Firebase está pronto e 'db' está disponível
                console.log("Configurando listeners do Firestore..."); // Depuração

                // Função auxiliar para criar e retornar o unsubscribe de um listener
                const setupListener = (collectionName, setStateFunction) => {
                    const colRef = window.collection(window.db, `artifacts/${window.firebaseAppId}/public/data/${collectionName}`);
                    return window.onSnapshot(colRef, snapshot => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setStateFunction(data);
                    }, error => console.error(`Erro ao obter ${collectionName}:`, error));
                };

                const unsubscribeClients = setupListener('clientes', setClientes);
                const unsubscribeContratos = setupListener('contratos', setContratos);
                const unsubscribeDetalhesCredito = setupListener('detalhes_credito', setDetalhesCredito);
                const unsubscribeDetalhesSeguro = setupListener('detalhes_seguro', setDetalhesSeguro);
                const unsubscribeDetalhesLegalizacaoConsultoria = setupListener('detalhes_legalizacao_consultoria', setDetalhesLegalizacaoConsultoria);
                const unsubscribeUtilizadores = setupListener('utilizadores', setUtilizadores);
                const unsubscribeFornecedores = setupListener('fornecedores', setFornecedores);
                const unsubscribeFinanceiras = setupListener('financeiras', setFinanceiras);
                const unsubscribeCompanhiasSeguros = setupListener('companhias_seguros', setCompanhiasSeguros);
                const unsubscribeTarefas = setupListener('tarefas', setTarefas);
                const unsubscribeInteracoes = setupListener('interacoes', setInteracoes);


                // Cleanup function: desinscreve todos os listeners quando o componente é desmontado
                return () => {
                    console.log("Desinscrevendo listeners do Firestore."); // Depuração
                    unsubscribeClients();
                    unsubscribeContratos();
                    unsubscribeDetalhesCredito();
                    unsubscribeDetalhesSeguro();
                    unsubscribeDetalhesLegalizacaoConsultoria();
                    unsubscribeUtilizadores();
                    unsubscribeFornecedores();
                    unsubscribeFinanceiras();
                    unsubscribeCompanhiasSeguros();
                    unsubscribeTarefas();
                    unsubscribeInteracoes();
                };
            }, [isAuthReady]); // Depende de isAuthReady para garantir que o Firebase está inicializado

            const showAppModal = (title, message, onConfirm = null) => {
                setModalContent({ title, message, onConfirm });
                setShowModal(true);
            };

            const hideAppModal = () => {
                setShowModal(false);
                setModalContent({});
            };

            // Função para obter dados baseados na role do utilizador
            const getFilteredData = useCallback((data, commercialIdField = null) => {
                if (currentUserRole === 'Admin') {
                    return data;
                }
                const currentUserId = utilizadores.find(u => u.role === currentUserRole)?.id_utilizador;
                if (!currentUserId) return [];

                if (currentUserRole === 'Comercial') {
                    if (commercialIdField) {
                        return data.filter(item => item[commercialIdField] === currentUserId);
                    }
                    // Para clientes, filtramos pelo id_comercial_responsavel
                    // Para contratos, filtramos pelo id_comercial
                    if (data === clientes) {
                        return data.filter(item => item.id_comercial_responsavel === currentUserId);
                    }
                    if (data === contratos) {
                        return data.filter(item => item.id_comercial === currentUserId);
                    }
                    if (data === tarefas) { // Filtrar tarefas por responsável
                        return data.filter(item => item.id_utilizador_responsavel === currentUserId);
                    }
                    if (data === interacoes) { // Filtrar interações por utilizador que as registou
                        return data.filter(item => item.id_utilizador === currentUserId);
                    }
                    return []; // Outros dados não são filtrados por comercial
                }
                if (currentUserRole === 'Colaborador') {
                    return data; // Colaborador vê tudo, mas só consulta
                }
                return [];
            }, [currentUserRole, utilizadores, clientes, contratos, tarefas, interacoes]);

            // Funções CRUD do Firestore
            const addFirestoreDoc = async (collectionName, data) => {
                try {
                    const docRef = await window.addDoc(window.collection(window.db, `artifacts/${window.firebaseAppId}/public/data/${collectionName}`), data);
                    showAppModal('Sucesso', `${collectionName.slice(0, -1).charAt(0).toUpperCase() + collectionName.slice(0, -1).slice(1)} adicionado com sucesso!`);
                    return docRef.id;
                } catch (e) {
                    console.error("Erro ao adicionar documento: ", e);
                    showAppModal('Erro', `Erro ao adicionar ${collectionName.slice(0, -1)}.`);
                }
            };

            const updateFirestoreDoc = async (collectionName, docId, data) => {
                try {
                    await window.updateDoc(window.doc(window.db, `artifacts/${window.firebaseAppId}/public/data/${collectionName}/${docId}`), data);
                    showAppModal('Sucesso', `${collectionName.slice(0, -1).charAt(0).toUpperCase() + collectionName.slice(0, -1).slice(1)} atualizado com sucesso!`);
                } catch (e) {
                    console.error("Erro ao atualizar documento: ", e);
                    showAppModal('Erro', `Erro ao atualizar ${collectionName.slice(0, -1)}.`);
                }
            };

            const deleteFirestoreDoc = async (collectionName, docId) => {
                try {
                    await window.deleteDoc(window.doc(window.db, `artifacts/${window.firebaseAppId}/public/data/${collectionName}/${docId}`));
                    showAppModal('Sucesso', `${collectionName.slice(0, -1).charAt(0).toUpperCase() + collectionName.slice(0, -1).slice(1)} eliminado com sucesso!`);
                } catch (e) {
                    console.error("Erro ao eliminar documento: ", e);
                    showAppModal('Erro', `Erro ao eliminar ${collectionName.slice(0, -1)}.`);
                }
            };

            // Funções CRUD para Clientes
            const addClient = async (newClient) => {
                // Gerar um ID de cliente fictício para o campo id_cliente, mas o Firestore gerará o seu próprio ID de documento
                const clientCount = clientes.length > 0 ? Math.max(...clientes.map(c => parseInt(c.id_cliente.replace('CLI-', '')))) : 0;
                const newIdCliente = `CLI-${String(clientCount + 1).padStart(3, '0')}`;
                await addFirestoreDoc('clientes', { ...newClient, id_cliente: newIdCliente, data_criacao: new Date().toISOString().split('T')[0] });
            };

            const updateClient = async (updatedClient) => {
                await updateFirestoreDoc('clientes', updatedClient.id, updatedClient);
            };

            const deleteClient = async (id) => {
                const clientContracts = contratos.filter(c => c.id_cliente === clientes.find(cli => cli.id === id)?.id_cliente);
                const clientTasks = tarefas.filter(t => t.id_cliente === clientes.find(cli => cli.id === id)?.id_cliente);
                const clientInteracoes = interacoes.filter(i => i.id_cliente === clientes.find(cli => cli.id === id)?.id_cliente);

                if (clientContracts.length > 0 || clientTasks.length > 0 || clientInteracoes.length > 0) {
                    showAppModal('Erro', 'Não é possível eliminar o cliente, pois existem contratos, tarefas ou interações associadas. Elimine primeiro os itens associados.');
                    return;
                }
                showAppModal('Confirmar Eliminação', 'Tem a certeza que quer eliminar este cliente?', async () => {
                    await deleteFirestoreDoc('clientes', id);
                    hideAppModal();
                });
            };

            // Funções CRUD para Contratos
            const addContract = async (newContract) => {
                const contractCount = contratos.length > 0 ? Math.max(...contratos.map(c => parseInt(c.id_contrato.replace('CON-', '')))) : 0;
                const newIdContrato = `CON-${String(contractCount + 1).padStart(3, '0')}`;
                const docId = await addFirestoreDoc('contratos', { ...newContract, id_contrato: newIdContrato, data_criacao: new Date().toISOString().split('T')[0] });

                // Adicionar detalhes específicos do contrato
                if (docId) {
                    let detailsCollection;
                    let detailsData = { id_contrato: newIdContrato };
                    if (newContract.tipo_servico === 'Crédito') {
                        detailsCollection = 'detalhes_credito';
                        detailsData = {
                            ...detailsData,
                            id_financeira: newContract.id_financeira,
                            id_fornecedor: newContract.id_fornecedor,
                            valor_financiado: newContract.valor_financiado ? parseFloat(newContract.valor_financiado) : 0,
                            prazo_meses: newContract.prazo_meses ? parseInt(newContract.prazo_meses) : 0,
                            comissao_financeira: newContract.comissao_financeira ? parseFloat(newContract.comissao_financeira) : 0,
                            comissao_fornecedor: newContract.comissao_fornecedor ? parseFloat(newContract.comissao_fornecedor) : 0,
                            documentos_em_falta: newContract.documentos_em_falta,
                            lista_documentos_em_falta: newContract.lista_documentos_em_falta,
                            credito_realizado: newContract.credito_realizado,
                            data_realizacao: newContract.data_realizacao
                        };
                    } else if (newContract.tipo_servico === 'Seguro') {
                        detailsCollection = 'detalhes_seguro';
                        detailsData = {
                            ...detailsData,
                            id_companhia: newContract.id_companhia,
                            tipo_seguro: newContract.tipo_seguro,
                            valor_premio: newContract.valor_premio ? parseFloat(newContract.valor_premio) : 0,
                            freelancer: newContract.freelancer,
                            mediador: newContract.mediador,
                            renovacao_automatica: newContract.renovacao_automatica,
                            data_renovacao: newContract.data_renovacao
                        };
                    } else if (newContract.tipo_servico === 'Legalização' || newContract.tipo_servico === 'Consultoria') {
                        detailsCollection = 'detalhes_legalizacao_consultoria';
                        detailsData = {
                            ...detailsData,
                            tipo_processo: newContract.tipo_processo,
                            estado_processo: newContract.estado_processo,
                            honorarios: newContract.honorarios ? parseFloat(newContract.honorarios) : 0,
                            documentos_necessarios: newContract.documentos_necessarios
                        };
                    }
                    if (detailsCollection) {
                        await addFirestoreDoc(detailsCollection, detailsData);
                    }
                }
            };

            const updateContract = async (updatedContract) => {
                await updateFirestoreDoc('contratos', updatedContract.id, updatedContract);

                // Atualizar detalhes específicos do contrato
                let detailsCollection;
                let detailsData = {};
                let existingDetailDocId = null;

                if (updatedContract.tipo_servico === 'Crédito') {
                    detailsCollection = 'detalhes_credito';
                    existingDetailDocId = detalhesCredito.find(d => d.id_contrato === updatedContract.id_contrato)?.id;
                    detailsData = {
                        id_financeira: updatedContract.id_financeira,
                        id_fornecedor: updatedContract.id_fornecedor,
                        valor_financiado: updatedContract.valor_financiado ? parseFloat(updatedContract.valor_financiado) : 0,
                        prazo_meses: updatedContract.prazo_meses ? parseInt(updatedContract.prazo_meses) : 0,
                        comissao_financeira: updatedContract.comissao_financeira ? parseFloat(updatedContract.comissao_financeira) : 0,
                        comissao_fornecedor: updatedContract.comissao_fornecedor ? parseFloat(updatedContract.comissao_fornecedor) : 0,
                        documentos_em_falta: updatedContract.documentos_em_falta,
                        lista_documentos_em_falta: updatedContract.lista_documentos_em_falta,
                        credito_realizado: updatedContract.credito_realizado,
                        data_realizacao: updatedContract.data_realizacao
                    };
                } else if (updatedContract.tipo_servico === 'Seguro') {
                    detailsCollection = 'detalhes_seguro';
                    existingDetailDocId = detalhesSeguro.find(d => d.id_contrato === updatedContract.id_contrato)?.id;
                    detailsData = {
                        id_companhia: updatedContract.id_companhia,
                        tipo_seguro: updatedContract.tipo_seguro,
                        valor_premio: updatedContract.valor_premio ? parseFloat(updatedContract.valor_premio) : 0,
                        freelancer: updatedContract.freelancer,
                        mediador: updatedContract.mediador,
                        renovacao_automatica: updatedContract.renovacao_automatica,
                        data_renovacao: updatedContract.data_renovacao
                    };
                } else if (updatedContract.tipo_servico === 'Legalização' || updatedContract.tipo_servico === 'Consultoria') {
                    detailsCollection = 'detalhes_legalizacao_consultoria';
                    existingDetailDocId = detalhesLegalizacaoConsultoria.find(d => d.id_contrato === updatedContract.id_contrato)?.id;
                    detailsData = {
                        tipo_processo: updatedContract.tipo_processo,
                        estado_processo: updatedContract.estado_processo,
                        honorarios: updatedContract.honorarios ? parseFloat(updatedContract.honorarios) : 0,
                        documentos_necessarios: updatedContract.documentos_necessarios
                    };
                }

                if (detailsCollection && existingDetailDocId) {
                    await updateFirestoreDoc(detailsCollection, existingDetailDocId, detailsData);
                } else if (detailsCollection && !existingDetailDocId) {
                    // Se não existia detalhe e agora existe um tipo de serviço com detalhe, adiciona
                    await addFirestoreDoc(detailsCollection, { id_contrato: updatedContract.id_contrato, ...detailsData });
                }
            };

            const deleteContract = async (id) => {
                const contractTasks = tarefas.filter(t => t.id_contrato === contratos.find(c => c.id === id)?.id_contrato);
                const contractInteracoes = interacoes.filter(i => i.id_contrato === contratos.find(c => c.id === id)?.id_contrato);

                if (contractTasks.length > 0 || contractInteracoes.length > 0) {
                    showAppModal('Erro', 'Não é possível eliminar o contrato, pois existem tarefas ou interações associadas. Elimine primeiro os itens associados.');
                    return;
                }

                showAppModal('Confirmar Eliminação', 'Tem a certeza que quer eliminar este contrato?', async () => {
                    const contractToDelete = contratos.find(c => c.id === id);
                    if (contractToDelete) {
                        // Tentar eliminar detalhes associados
                        const creditDetail = detalhesCredito.find(d => d.id_contrato === contractToDelete.id_contrato);
                        if (creditDetail) await deleteFirestoreDoc('detalhes_credito', creditDetail.id);
                        const seguroDetail = detalhesSeguro.find(d => d.id_contrato === contractToDelete.id_contrato);
                        if (seguroDetail) await deleteFirestoreDoc('detalhes_seguro', seguroDetail.id);
                        const legalizacaoConsultoriaDetail = detalhesLegalizacaoConsultoria.find(d => d.id_contrato === contractToDelete.id_contrato);
                        if (legalizacaoConsultoriaDetail) await deleteFirestoreDoc('detalhes_legalizacao_consultoria', legalizacaoConsultoriaDetail.id);
                    }
                    await deleteFirestoreDoc('contratos', id);
                    hideAppModal();
                });
            };

            const markPendingAsResolved = async (contractId) => {
                const contractDoc = contratos.find(c => c.id_contrato === contractId);
                if (contractDoc) {
                    await updateFirestoreDoc('contratos', contractDoc.id, { estado: 'Ativo', observacoes: 'Pendência resolvida.' });
                }
            };

            // Funções CRUD para Fornecedores, Financeiras, Companhias
            const addSupplierFinanceiraCompanhia = async (type, data) => {
                let collectionName;
                let newIdPrefix;
                if (type === 'fornecedor') {
                    collectionName = 'fornecedores';
                    newIdPrefix = 'FOR';
                } else if (type === 'financeira') {
                    collectionName = 'financeiras';
                    newIdPrefix = 'FIN';
                } else if (type === 'companhia') {
                    collectionName = 'companhias_seguros';
                    newIdPrefix = 'COMP';
                }

                const currentData = type === 'fornecedor' ? fornecedores : type === 'financeira' ? financeiras : companhiasSeguros;
                const maxId = currentData.length > 0 ? Math.max(...currentData.map(item => parseInt(item[`id_${type}`].replace(`${newIdPrefix}-`, '')))) : 0;
                const newGeneratedId = `${newIdPrefix}-${String(maxId + 1).padStart(3, '0')}`;

                await addFirestoreDoc(collectionName, { [`id_${type}`]: newGeneratedId, ...data });
            };

            const updateSupplierFinanceiraCompanhia = async (type, docId, data) => {
                let collectionName;
                if (type === 'fornecedor') collectionName = 'fornecedores';
                else if (type === 'financeira') collectionName = 'financeiras';
                else if (type === 'companhia') collectionName = 'companhias_seguros';

                await updateFirestoreDoc(collectionName, docId, data);
            };

            const deleteSupplierFinanceiraCompanhia = async (type, id) => {
                let collectionName;
                if (type === 'fornecedor') collectionName = 'fornecedores';
                else if (type === 'financeira') collectionName = 'financeiras';
                else if (type === 'companhia') collectionName = 'companhias_seguros';

                showAppModal('Confirmar Eliminação', `Tem a certeza que quer eliminar este ${type}?`, async () => {
                    await deleteFirestoreDoc(collectionName, id);
                    hideAppModal();
                });
            };

            // Funções CRUD para Tarefas
            const addTask = async (newTask) => {
                const taskCount = tarefas.length > 0 ? Math.max(...tarefas.map(t => parseInt(t.id_tarefa.replace('TASK-', '')))) : 0;
                const newIdTarefa = `TASK-${String(taskCount + 1).padStart(3, '0')}`;
                await addFirestoreDoc('tarefas', { ...newTask, id_tarefa: newIdTarefa, data_criacao: new Date().toISOString().split('T')[0] });
            };

            const updateTask = async (updatedTask) => {
                await updateFirestoreDoc('tarefas', updatedTask.id, updatedTask);
            };

            const deleteTask = async (id) => {
                showAppModal('Confirmar Eliminação', 'Tem a certeza que quer eliminar esta tarefa?', async () => {
                    await deleteFirestoreDoc('tarefas', id);
                    hideAppModal();
                });
            };

            // Funções CRUD para Interações
            const addInteraction = async (newInteraction) => {
                const interactionCount = interacoes.length > 0 ? Math.max(...interacoes.map(i => parseInt(i.id_interacao.replace('INT-', '')))) : 0;
                const newIdInteracao = `INT-${String(interactionCount + 1).padStart(3, '0')}`;
                await addFirestoreDoc('interacoes', { ...newInteraction, id_interacao: newIdInteracao, data_interacao: new Date().toISOString().slice(0, 19) }); // YYYY-MM-DDTHH:MM:SS
            };

            // Não há update/delete direto de interações por agora, apenas adicionar para histórico

            if (!isAuthReady) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-100">
                        <p className="text-xl text-gray-700">A carregar aplicação e a autenticar...</p>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 text-gray-800">
                    <header className="bg-accent-beige text-primary-dark p-4 shadow-lg">
                        <div className="container mx-auto flex flex-col md:flex-row items-center justify-between">
                            <div className="mb-2 md:mb-0">
                                <img src="https://firebasestorage.googleapis.com/v0/b/generative-ai-sandbox.appspot.com/o/2.png?alt=media&token=26ba8771-437b-41a8-ba9e-9f301d1d3922" alt="THE WAY Logo" className="h-12 w-auto" />
                            </div>
                            <nav className="flex space-x-4 md:space-x-6 text-lg">
                                <button onClick={() => setActiveTab('dashboard')} className={`px-3 py-2 rounded-md transition duration-300 ${activeTab === 'dashboard' ? 'bg-primary-dark text-white' : 'hover:bg-light-grey-custom'}`}>Dashboard</button>
                                <button onClick={() => setActiveTab('clientes')} className={`px-3 py-2 rounded-md transition duration-300 ${activeTab === 'clientes' ? 'bg-primary-dark text-white' : 'hover:bg-light-grey-custom'}`}>Clientes</button>
                                <button onClick={() => setActiveTab('contratos')} className={`px-3 py-2 rounded-md transition duration-300 ${activeTab === 'contratos' ? 'bg-primary-dark text-white' : 'hover:bg-light-grey-custom'}`}>Contratos</button>
                                <button onClick={() => setActiveTab('tarefas')} className={`px-3 py-2 rounded-md transition duration-300 ${activeTab === 'tarefas' ? 'bg-primary-dark text-white' : 'hover:bg-light-grey-custom'}`}>Tarefas</button>
                                {(currentUserRole === 'Admin') && (
                                    <>
                                        <button onClick={() => setActiveTab('fornecedores')} className={`px-3 py-2 rounded-md transition duration-300 ${activeTab === 'fornecedores' ? 'bg-primary-dark text-white' : 'hover:bg-light-grey-custom'}`}>Fornecedores/Financeiras</button>
                                        <button onClick={() => setActiveTab('relatorios')} className={`px-3 py-2 rounded-md transition duration-300 ${activeTab === 'relatorios' ? 'bg-primary-dark text-white' : 'hover:bg-light-grey-custom'}`}>Relatórios</button>
                                    </>
                                )}
                            </nav>
                            <div className="mt-2 md:mt-0 flex items-center space-x-4">
                                <label htmlFor="role-select" className="sr-only">Selecionar Função</label>
                                <select
                                    id="role-select"
                                    value={currentUserRole}
                                    onChange={(e) => setCurrentUserRole(e.target.value)}
                                    className="bg-primary-dark text-white rounded-md p-2 text-sm focus:outline-none focus:ring-2 focus:ring-light-grey-custom"
                                >
                                    <option value="Admin">Admin</option>
                                    <option value="Comercial">Comercial</option>
                                    <option value="Colaborador">Colaborador</option>
                                </select>
                                {userId && (
                                    <span className="text-sm text-primary-dark bg-light-grey-custom px-3 py-1 rounded-md">
                                        ID: {userId}
                                    </span>
                                )}
                            </div>
                        </div>
                    </header>

                    <main className="container mx-auto p-4 mt-4">
                        {activeTab === 'dashboard' && (
                            <Dashboard
                                clientes={getFilteredData(clientes, 'id_comercial_responsavel')}
                                contratos={getFilteredData(contratos, 'id_comercial')}
                                utilizadores={utilizadores}
                                markPendingAsResolved={markPendingAsResolved}
                                currentUserRole={currentUserRole}
                                detalhesCredito={detalhesCredito}
                                detalhesSeguro={detalhesSeguro}
                                detalhesLegalizacaoConsultoria={detalhesLegalizacaoConsultoria}
                                tarefas={getFilteredData(tarefas, 'id_utilizador_responsavel')}
                                showAppModal={showAppModal}
                            />
                        )}
                        {activeTab === 'clientes' && (
                            <ClientManagement
                                clientes={getFilteredData(clientes, 'id_comercial_responsavel')}
                                addClient={addClient}
                                updateClient={updateClient}
                                deleteClient={deleteClient}
                                contratos={contratos}
                                utilizadores={utilizadores}
                                currentUserRole={currentUserRole}
                                showAppModal={showAppModal}
                                interacoes={interacoes}
                                addInteraction={addInteraction}
                            />
                        )}
                        {activeTab === 'contratos' && (
                            <ContractManagement
                                contratos={getFilteredData(contratos, 'id_comercial')}
                                addContract={addContract}
                                updateContract={updateContract}
                                deleteContract={deleteContract}
                                clientes={clientes}
                                fornecedores={fornecedores}
                                financeiras={financeiras}
                                companhiasSeguros={companhiasSeguros}
                                utilizadores={utilizadores}
                                currentUserRole={currentUserRole}
                                showAppModal={showAppModal}
                                detalhesCredito={detalhesCredito}
                                detalhesSeguro={detalhesSeguro}
                                detalhesLegalizacaoConsultoria={detalhesLegalizacaoConsultoria}
                                interacoes={interacoes}
                                addInteraction={addInteraction}
                            />
                        )}
                        {activeTab === 'tarefas' && (
                            <TaskManagement
                                tarefas={getFilteredData(tarefas, 'id_utilizador_responsavel')}
                                addTask={addTask}
                                updateTask={updateTask}
                                deleteTask={deleteTask}
                                clientes={clientes}
                                contratos={contratos}
                                utilizadores={utilizadores}
                                currentUserRole={currentUserRole}
                                showAppModal={showAppModal}
                            />
                        )}
                        {activeTab === 'fornecedores' && currentUserRole === 'Admin' && (
                            <SuppliersFinancialsManagement
                                fornecedores={fornecedores}
                                financeiras={financeiras}
                                companhiasSeguros={companhiasSeguros}
                                addEntity={addSupplierFinanceiraCompanhia}
                                updateEntity={updateSupplierFinanceiraCompanhia}
                                deleteEntity={deleteSupplierFinanceiraCompanhia}
                                showAppModal={showAppModal}
                            />
                        )}
                        {activeTab === 'relatorios' && currentUserRole === 'Admin' && (
                            <SupplierReport
                                fornecedores={fornecedores}
                                contratos={contratos}
                                detalhesCredito={detalhesCredito}
                                clientes={clientes}
                                showAppModal={showAppModal}
                            />
                        )}
                    </main>

                    <footer className="bg-primary-dark text-white p-4 mt-8 rounded-t-lg">
                        <div className="container mx-auto text-center text-sm">
                            <p>&copy; 2024 THE WAY. Todos os direitos reservados.</p>
                        </div>
                    </footer>

                    {showModal && (
                        <Modal
                            title={modalContent.title}
                            message={modalContent.message}
                            onClose={hideAppModal}
                            onConfirm={modalContent.onConfirm}
                            showConfirm={!!modalContent.onConfirm}
                        />
                    )}
                </div>
            );
        };

        // Componente Dashboard
        const Dashboard = ({ clientes, contratos, utilizadores, markPendingAsResolved, currentUserRole, detalhesCredito, detalhesSeguro, detalhesLegalizacaoConsultoria, tarefas, showAppModal }) => {
            const contratosPendentes = contratos.filter(c => c.estado === 'Pendente');
            const tarefasPendentes = tarefas.filter(t => t.estado === 'Pendente');

            const totalVolumeFaturado = contratos.reduce((sum, c) => {
                let valor = 0;
                if (c.tipo_servico === 'Crédito') {
                    const detalhe = detalhesCredito.find(dc => dc.id_contrato === c.id_contrato);
                    valor = detalhe ? detalhe.comissao_financeira + detalhe.comissao_fornecedor : 0;
                } else if (c.tipo_servico === 'Seguro') {
                    const detalhe = detalhesSeguro.find(ds => ds.id_contrato === c.id_contrato);
                    valor = detalhe ? ds.valor_premio : 0;
                } else if (c.tipo_servico === 'Legalização' || c.tipo_servico === 'Consultoria') {
                    const detalhe = detalhesLegalizacaoConsultoria.find(dlc => dlc.id_contrato === c.id_contrato);
                    valor = detalhe ? dlc.honorarios : 0;
                }
                return sum + valor;
            }, 0);

            const contratosPorTipoRef = useRef(null);
            const contratosPorMesRef = useRef(null);

            useEffect(() => {
                if (contratosPorTipoRef.current) {
                    contratosPorTipoRef.current.destroy();
                }
                if (contratosPorMesRef.current) {
                    contratosPorMesRef.current.destroy();
                }

                // Gráfico de Contratos por Tipo de Serviço
                const contratosPorTipoData = contratos.reduce((acc, c) => {
                    acc[c.tipo_servico] = (acc[c.tipo_servico] || 0) + 1;
                    return acc;
                }, {});

                const ctxTipo = document.getElementById('contratosPorTipoChart').getContext('2d');
                contratosPorTipoRef.current = new Chart(ctxTipo, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(contratosPorTipoData).map(label => wrapLabels(label)),
                        datasets: [{
                            data: Object.values(contratosPorTipoData),
                            backgroundColor: ['var(--color-beige)', 'var(--color-light-grey)', 'var(--color-dark-black)', '#F59E0B'], /* Using new palette and one existing for variety */
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += context.parsed;
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });

                // Gráfico de Contratos por Mês
                const contratosPorMesData = contratos.reduce((acc, c) => {
                    const month = new Date(c.data_criacao).toLocaleString('pt-PT', { month: 'short', year: '2-digit' });
                    acc[month] = (acc[month] || 0) + 1;
                    return acc;
                }, {});

                const sortedMonths = Object.keys(contratosPorMesData).sort((a, b) => {
                    const [monthA, yearA] = a.split('/');
                    const [monthB, yearB] = b.split('/');
                    const dateA = new Date(`01 ${monthA} 20${yearA}`);
                    const dateB = new Date(`01 ${monthB} 20${yearB}`);
                    return dateA - dateB;
                });

                const ctxMes = document.getElementById('contratosPorMesChart').getContext('2d');
                contratosPorMesRef.current = new Chart(ctxMes, {
                    type: 'bar',
                    data: {
                        labels: sortedMonths,
                        datasets: [{
                            label: 'Nº de Contratos',
                            data: sortedMonths.map(month => contratosPorMesData[month]),
                            backgroundColor: 'var(--color-beige)',
                            borderColor: 'var(--color-dark-black)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y;
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (contratosPorTipoRef.current) {
                        contratosPorTipoRef.current.destroy();
                    }
                    if (contratosPorMesRef.current) {
                        contratosPorMesRef.current.destroy();
                    }
                };
            }, [contratos, detalhesCredito, detalhesSeguro, detalhesLegalizacaoConsultoria]);

            return (
                <section className="bg-white p-8 rounded-xl shadow-md mb-12">
                    <h2 className="text-3xl font-bold text-primary-dark mb-6 text-center">Dashboard Principal</h2>
                    <p className="text-gray-700 mb-8 text-center">
                        Esta secção oferece uma visão geral e interativa do desempenho da empresa, com KPIs e gráficos que resumem os dados de clientes e contratos.
                    </p>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                        <div className="bg-light-grey-custom p-6 rounded-lg shadow-sm text-center">
                            <h3 className="text-xl font-semibold text-primary-dark">Total de Clientes</h3>
                            <p className="text-5xl font-bold text-primary-dark mt-2">{clientes.length}</p>
                        </div>
                        <div className="bg-light-grey-custom p-6 rounded-lg shadow-sm text-center">
                            <h3 className="text-xl font-semibold text-primary-dark">Contratos Ativos</h3>
                            <p className="text-5xl font-bold text-primary-dark mt-2">{contratos.filter(c => c.estado === 'Ativo').length}</p>
                        </div>
                        <div className="bg-light-grey-custom p-6 rounded-lg shadow-sm text-center">
                            <h3 className="text-xl font-semibold text-primary-dark">Volume Faturado (Simulado)</h3>
                            <p className="text-5xl font-bold text-primary-dark mt-2">{totalVolumeFaturado.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' })}</p>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
                        <div className="bg-gray-50 p-6 rounded-lg shadow-sm flex flex-col items-center">
                            <h3 className="text-xl font-semibold text-primary-dark mb-4">Contratos por Tipo de Serviço</h3>
                            <div className="chart-container">
                                <canvas id="contratosPorTipoChart"></canvas>
                            </div>
                        </div>
                        <div className="bg-gray-50 p-6 rounded-lg shadow-sm flex flex-col items-center">
                            <h3 className="text-xl font-semibold text-primary-dark mb-4">Novos Contratos por Mês</h3>
                            <div className="chart-container">
                                <canvas id="contratosPorMesChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <h3 className="text-2xl font-bold text-primary-dark mb-4 text-center">Alertas de Pendências e Tarefas</h3>
                    <p className="text-gray-700 mb-6 text-center">
                        Esta tabela lista os contratos com pendências e tarefas pendentes, permitindo um acompanhamento rápido e a resolução direta por parte dos comerciais.
                    </p>
                    {(contratosPendentes.length === 0 && tarefasPendentes.length === 0) ? (
                        <p className="text-center text-gray-600 text-lg">Não há pendências ou tarefas no momento. Bom trabalho!</p>
                    ) : (
                        <div className="overflow-x-auto rounded-lg shadow">
                            <table className="min-w-full bg-white">
                                <thead className="bg-light-grey-custom">
                                    <tr>
                                        <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Tipo</th>
                                        <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Item Relacionado</th>
                                        <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Descrição/Título</th>
                                        <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Responsável</th>
                                        <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Data Vencimento/Criação</th>
                                        {currentUserRole !== 'Colaborador' && (
                                            <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Ações</th>
                                        )}
                                    </tr>
                                </thead>
                                <tbody>
                                    {/* Contratos Pendentes */}
                                    {contratosPendentes.map(c => {
                                        const cliente = clientes.find(cli => cli.id_cliente === c.id_cliente);
                                        const comercial = utilizadores.find(u => u.id_utilizador === c.id_comercial);
                                        const daysPending = Math.floor((new Date() - new Date(c.data_criacao)) / (1000 * 60 * 60 * 24));
                                        return (
                                            <tr key={`contract-${c.id}`} className="border-b border-gray-200 hover:bg-gray-50">
                                                <td className="py-3 px-4 text-sm text-gray-700">Contrato Pendente</td>
                                                <td className="py-3 px-4 text-sm text-gray-700">{c.id_contrato} ({cliente ? cliente.nome : 'N/A'})</td>
                                                <td className="py-3 px-4 text-sm text-gray-700">{c.observacoes || 'N/A'}</td>
                                                <td className="py-3 px-4 text-sm text-gray-700">{comercial ? comercial.nome : 'N/A'}</td>
                                                <td className="py-3 px-4 text-sm text-gray-700">{c.data_criacao} ({daysPending} dias)</td>
                                                {currentUserRole !== 'Colaborador' && (
                                                    <td className="py-3 px-4 text-sm text-gray-700">
                                                        <button
                                                            onClick={() => markPendingAsResolved(c.id_contrato)}
                                                            className="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 transform hover:scale-105"
                                                        >
                                                            Resolver
                                                        </button>
                                                    </td>
                                                )}
                                            </tr>
                                        );
                                    })}
                                    {/* Tarefas Pendentes */}
                                    {tarefasPendentes.map(t => {
                                        const cliente = t.id_cliente ? clientes.find(cli => cli.id_cliente === t.id_cliente) : null;
                                        const contrato = t.id_contrato ? contratos.find(con => con.id_contrato === t.id_contrato) : null;
                                        const responsavel = utilizadores.find(u => u.id_utilizador === t.id_utilizador_responsavel);
                                        return (
                                            <tr key={`task-${t.id}`} className="border-b border-gray-200 hover:bg-gray-50">
                                                <td className="py-3 px-4 text-sm text-gray-700">Tarefa ({t.prioridade})</td>
                                                <td className="py-3 px-4 text-sm text-gray-700">
                                                    {cliente ? `Cliente: ${cliente.nome}` : ''}
                                                    {contrato ? ` Contrato: ${contrato.id_contrato}` : ''}
                                                    {(!cliente && !contrato) ? 'Geral' : ''}
                                                </td>
                                                <td className="py-3 px-4 text-sm text-gray-700">{t.titulo}</td>
                                                <td className="py-3 px-4 text-sm text-gray-700">{responsavel ? responsavel.nome : 'N/A'}</td>
                                                <td className="py-3 px-4 text-sm text-gray-700">{t.data_vencimento}</td>
                                                {currentUserRole !== 'Colaborador' && (
                                                    <td className="py-3 px-4 text-sm text-gray-700">
                                                        <button
                                                            onClick={() => showAppModal('Concluir Tarefa', `Tem a certeza que quer marcar a tarefa "${t.titulo}" como concluída?`, async () => { await updateTask({ ...t, estado: 'Concluída' }); showAppModal('Sucesso', 'Tarefa marcada como concluída!'); })}
                                                            className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 transform hover:scale-105"
                                                        >
                                                            Concluir
                                                        </button>
                                                    </td>
                                                )}
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    )}
                </section>
            );
        };

        // Componente Gestão de Clientes
        const ClientManagement = ({ clientes, addClient, updateClient, deleteClient, contratos, utilizadores, currentUserRole, showAppModal, interacoes, addInteraction }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [filterType, setFilterType] = useState('');
            const [editingClient, setEditingClient] = useState(null);
            const [showClientForm, setShowClientForm] = useState(false);
            const [clientDetails, setClientDetails] = useState(null);
            const [newInteractionData, setNewInteractionData] = useState({ tipo_interacao: 'Chamada', observacoes: '' });

            const [newClientData, setNewClientData] = useState({
                nome: '', nif: '', data_nascimento: '', email: '', telefone: '', morada: '', tipo_cliente: 'Particular', id_comercial_responsavel: '', rgpd_assinado: false, observacoes: '', uploads: []
            });

            const handleInputChange = (e) => {
                const { name, value, type, checked } = e.target;
                setNewClientData(prev => ({
                    ...prev,
                    [name]: type === 'checkbox' ? checked : value
                }));
            };

            const handleInteractionChange = (e) => {
                const { name, value } = e.target;
                setNewInteractionData(prev => ({ ...prev, [name]: value }));
            };

            const handleAddInteraction = async (clientId) => {
                if (!newInteractionData.observacoes.trim()) {
                    showAppModal('Atenção', 'Por favor, adicione uma observação para a interação.');
                    return;
                }
                const currentUserId = window.auth.currentUser?.uid || 'anonymous'; // Obter o ID do utilizador logado
                await addInteraction({
                    id_cliente: clientId,
                    id_contrato: null, // Interação específica do cliente, não de contrato
                    tipo_interacao: newInteractionData.tipo_interacao,
                    observacoes: newInteractionData.observacoes,
                    id_utilizador: currentUserId
                });
                setNewInteractionData({ tipo_interacao: 'Chamada', observacoes: '' });
                showAppModal('Sucesso', 'Interação registada com sucesso!');
            };


            const handleSubmit = async (e) => {
                e.preventDefault();
                if (editingClient) {
                    await updateClient({ ...newClientData, id: editingClient.id });
                } else {
                    await addClient(newClientData);
                }
                setNewClientData({ nome: '', nif: '', data_nascimento: '', email: '', telefone: '', morada: '', tipo_cliente: 'Particular', id_comercial_responsavel: '', rgpd_assinado: false, observacoes: '', uploads: [] });
                setEditingClient(null);
                setShowClientForm(false);
            };

            const startEdit = (client) => {
                setEditingClient(client);
                setNewClientData({ ...client });
                setShowClientForm(true);
                setClientDetails(null); // Fecha detalhes se estiverem abertos
            };

            const viewDetails = (client) => {
                setClientDetails(client);
                setShowClientForm(false); // Fecha formulário se estiver aberto
            };

            const filteredClients = clientes.filter(client => {
                const matchesSearch = client.nome.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                      client.nif.includes(searchTerm);
                const matchesType = filterType === '' || client.tipo_cliente === filterType;
                return matchesSearch && matchesType;
            });

            const getClientContracts = (clientId) => {
                // clientId aqui é o id_cliente (CLI-001, etc.)
                return contratos.filter(c => c.id_cliente === clientId);
            };

            const getClientInteractions = (clientId) => {
                return interacoes.filter(i => i.id_cliente === clientId).sort((a, b) => new Date(b.data_interacao) - new Date(a.data_interacao));
            };

            const getComercialName = (id) => {
                const comercial = utilizadores.find(u => u.id_utilizador === id);
                return comercial ? comercial.nome : 'N/A';
            };

            const getUserName = (id) => {
                const user = utilizadores.find(u => u.id_utilizador === id);
                return user ? user.nome : 'N/A';
            };

            return (
                <section className="bg-white p-8 rounded-xl shadow-md mb-12">
                    <h2 className="text-3xl font-bold text-primary-dark mb-6 text-center">Gestão de Clientes</h2>
                    <p className="text-gray-700 mb-8 text-center">
                        Esta secção permite gerir todos os clientes da THE WAY, incluindo os seus dados pessoais, tipo de cliente e contratos associados.
                    </p>

                    <div className="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div className="flex-grow flex flex-col sm:flex-row gap-4 w-full sm:w-auto">
                            <input
                                type="text"
                                placeholder="Pesquisar por nome ou NIF..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="p-2 border border-light-grey-custom rounded-lg w-full sm:w-64 focus:outline-none focus:ring-2 focus:ring-accent-beige"
                            />
                            <select
                                value={filterType}
                                onChange={(e) => setFilterType(e.target.value)}
                                className="p-2 border border-light-grey-custom rounded-lg w-full sm:w-48 focus:outline-none focus:ring-2 focus:ring-accent-beige"
                            >
                                <option value="">Todos os Tipos</option>
                                <option value="Particular">Particular</option>
                                <option value="Empresa">Empresa</option>
                            </select>
                        </div>
                        {currentUserRole !== 'Colaborador' && (
                            <button
                                onClick={() => { setShowClientForm(true); setEditingClient(null); setNewClientData({ nome: '', nif: '', data_nascimento: '', email: '', telefone: '', morada: '', tipo_cliente: 'Particular', id_comercial_responsavel: '', rgpd_assinado: false, observacoes: '', uploads: [] }); setClientDetails(null); }}
                                className="bg-accent-beige hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105 w-full sm:w-auto"
                            >
                                Adicionar Novo Cliente
                            </button>
                        )}
                    </div>

                    {showClientForm && (
                        <div className="bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
                            <h3 className="text-2xl font-bold text-primary-dark mb-4">{editingClient ? 'Editar Cliente' : 'Novo Cliente'}</h3>
                            <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label className="block">
                                    <span className="text-gray-700">Nome:</span>
                                    <input type="text" name="nome" value={newClientData.nome} onChange={handleInputChange} required className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2" />
                                </label>
                                <label className="block">
                                    <span className="text-gray-700">NIF:</span>
                                    <input type="text" name="nif" value={newClientData.nif} onChange={handleInputChange} required className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2" />
                                </label>
                                <label className="block">
                                    <span className="text-gray-700">Data de Nascimento:</span>
                                    <input type="date" name="data_nascimento" value={newClientData.data_nascimento} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2" />
                                </label>
                                <label className="block">
                                    <span className="text-gray-700">Email:</span>
                                    <input type="email" name="email" value={newClientData.email} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2" />
                                </label>
                                <label className="block">
                                    <span className="text-gray-700">Telefone:</span>
                                    <input type="text" name="telefone" value={newClientData.telefone} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2" />
                                </label>
                                <label className="block col-span-1 md:col-span-2">
                                    <span className="text-gray-700">Morada:</span>
                                    <input type="text" name="morada" value={newClientData.morada} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2" />
                                </label>
                                <label className="block">
                                    <span className="text-gray-700">Tipo de Cliente:</span>
                                    <select name="tipo_cliente" value={newClientData.tipo_cliente} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2">
                                        <option value="Particular">Particular</option>
                                        <option value="Empresa">Empresa</option>
                                    </select>
                                </label>
                                <label className="block">
                                    <span className="text-gray-700">Comercial Responsável:</span>
                                    <select name="id_comercial_responsavel" value={newClientData.id_comercial_responsavel} onChange={handleInputChange} required className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2">
                                        <option value="">Selecionar Comercial</option>
                                        {utilizadores.filter(u => u.role === 'Comercial' || u.role === 'Admin').map(u => (
                                            <option key={u.id} value={u.id_utilizador}>{u.nome}</option>
                                        ))}
                                    </select>
                                </label>
                                <label className="flex items-center mt-2 col-span-1 md:col-span-2">
                                    <input type="checkbox" name="rgpd_assinado" checked={newClientData.rgpd_assinado} onChange={handleInputChange} className="form-checkbox h-5 w-5 text-accent-beige rounded" />
                                    <span className="ml-2 text-gray-700">RGPD Assinado</span>
                                </label>
                                <label className="block col-span-1 md:col-span-2">
                                    <span className="text-gray-700">Observações:</span>
                                    <textarea name="observacoes" value={newClientData.observacoes} onChange={handleInputChange} rows="3" className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2"></textarea>
                                </label>
                                <div className="col-span-1 md:col-span-2 flex justify-end space-x-4 mt-4">
                                    <button type="button" onClick={() => setShowClientForm(false)} className="bg-light-grey-custom hover:bg-primary-dark text-primary-dark hover:text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105">Cancelar</button>
                                    <button type="submit" className="bg-accent-beige hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105">
                                        {editingClient ? 'Atualizar Cliente' : 'Adicionar Cliente'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}

                    {clientDetails && (
                        <div className="bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
                            <h3 className="text-2xl font-bold text-primary-dark mb-4">Detalhes do Cliente: {clientDetails.nome}</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700 mb-6">
                                <p><strong>ID:</strong> {clientDetails.id_cliente}</p>
                                <p><strong>NIF:</strong> {clientDetails.nif}</p>
                                <p><strong>Data Nasc.:</strong> {clientDetails.data_nascimento}</p>
                                <p><strong>Email:</strong> {clientDetails.email}</p>
                                <p><strong>Telefone:</strong> {clientDetails.telefone}</p>
                                <p className="md:col-span-2"><strong>Morada:</strong> {clientDetails.morada}</p>
                                <p><strong>Tipo:</strong> {clientDetails.tipo_cliente}</p>
                                <p><strong>Comercial Resp.:</strong> {getComercialName(clientDetails.id_comercial_responsavel)}</p>
                                <p><strong>Data Criação:</strong> {clientDetails.data_criacao}</p>
                                <p><strong>RGPD Assinado:</strong> {clientDetails.rgpd_assinado ? 'Sim' : 'Não'}</p>
                                <p className="md:col-span-2"><strong>Observações:</strong> {clientDetails.observacoes || 'N/A'}</p>
                            </div>

                            <h4 className="text-xl font-bold text-primary-dark mb-3">Documentos (Simulados)</h4>
                            {clientDetails.uploads && clientDetails.uploads.length > 0 ? (
                                <ul className="list-disc list-inside text-gray-700 mb-6">
                                    {clientDetails.uploads.map((docName, index) => (
                                        <li key={index} className="flex items-center justify-between py-1">
                                            <span>{docName}</span>
                                            <button className="bg-light-grey-custom hover:bg-primary-dark text-primary-dark hover:text-white text-xs px-2 py-1 rounded-md">Ver</button>
                                        </li>
                                    ))}
                                </ul>
                            ) : (
                                <p className="text-gray-600 mb-6">Nenhum documento anexado.</p>
                            )}

                            <h4 className="text-xl font-bold text-primary-dark mb-3">Contratos Associados</h4>
                            {getClientContracts(clientDetails.id_cliente).length > 0 ? (
                                <div className="overflow-x-auto rounded-lg shadow">
                                    <table className="min-w-full bg-white">
                                        <thead className="bg-light-grey-custom">
                                            <tr>
                                                <th className="py-2 px-3 text-left text-xs font-semibold text-primary-dark">ID Contrato</th>
                                                <th className="py-2 px-3 text-left text-xs font-semibold text-primary-dark">Tipo Serviço</th>
                                                <th className="py-2 px-3 text-left text-xs font-semibold text-primary-dark">Estado</th>
                                                <th className="py-2 px-3 text-left text-xs font-semibold text-primary-dark">Início</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {getClientContracts(clientDetails.id_cliente).map(contract => (
                                                <tr key={contract.id} className="border-b border-gray-200 hover:bg-gray-50">
                                                    <td className="py-2 px-3 text-sm text-gray-700">{contract.id_contrato}</td>
                                                    <td className="py-2 px-3 text-sm text-gray-700">{contract.tipo_servico}</td>
                                                    <td className="py-2 px-3 text-sm text-gray-700">{contract.estado}</td>
                                                    <td className="py-2 px-3 text-sm text-gray-700">{contract.data_inicio}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            ) : (
                                <p className="text-gray-600">Nenhum contrato associado.</p>
                            )}

                            <h4 className="text-xl font-bold text-primary-dark mb-3 mt-6">Histórico de Interações</h4>
                            <div className="bg-white p-4 rounded-lg shadow-sm mb-4">
                                <h5 className="text-lg font-semibold text-primary-dark mb-2">Adicionar Nova Interação</h5>
                                <div className="flex flex-col md:flex-row gap-3 items-end">
                                    <div className="flex-grow">
                                        <label className="block text-gray-700 text-sm">Tipo de Interação:</label>
                                        <select
                                            name="tipo_interacao"
                                            value={newInteractionData.tipo_interacao}
                                            onChange={handleInteractionChange}
                                            className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2"
                                        >
                                            <option value="Chamada">Chamada</option>
                                            <option value="Email">Email</option>
                                            <option value="Reunião">Reunião</option>
                                            <option value="Nota">Nota</option>
                                        </select>
                                    </div>
                                    <div className="flex-grow-[2]">
                                        <label className="block text-gray-700 text-sm">Observações:</label>
                                        <textarea
                                            name="observacoes"
                                            value={newInteractionData.observacoes}
                                            onChange={handleInteractionChange}
                                            rows="2"
                                            className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2"
                                            placeholder="Descreva a interação..."
                                        ></textarea>
                                    </div>
                                    <button
                                        onClick={() => handleAddInteraction(clientDetails.id_cliente)}
                                        className="bg-accent-beige hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg text-sm transition duration-300 transform hover:scale-105"
                                    >
                                        Registar
                                    </button>
                                </div>
                            </div>
                            {getClientInteractions(clientDetails.id_cliente).length > 0 ? (
                                <div className="overflow-x-auto rounded-lg shadow">
                                    <table className="min-w-full bg-white">
                                        <thead className="bg-light-grey-custom">
                                            <tr>
                                                <th className="py-2 px-3 text-left text-xs font-semibold text-primary-dark">Data</th>
                                                <th className="py-2 px-3 text-left text-xs font-semibold text-primary-dark">Tipo</th>
                                                <th className="py-2 px-3 text-left text-xs font-semibold text-primary-dark">Observações</th>
                                                <th className="py-2 px-3 text-left text-xs font-semibold text-primary-dark">Utilizador</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {getClientInteractions(clientDetails.id_cliente).map(interaction => (
                                                <tr key={interaction.id} className="border-b border-gray-200 hover:bg-gray-50">
                                                    <td className="py-2 px-3 text-sm text-gray-700">{new Date(interaction.data_interacao).toLocaleString('pt-PT')}</td>
                                                    <td className="py-2 px-3 text-sm text-gray-700">{interaction.tipo_interacao}</td>
                                                    <td className="py-2 px-3 text-sm text-gray-700">{interaction.observacoes}</td>
                                                    <td className="py-2 px-3 text-sm text-gray-700">{getUserName(interaction.id_utilizador)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            ) : (
                                <p className="text-gray-600">Nenhuma interação registada para este cliente.</p>
                            )}

                            <div className="flex justify-end mt-6">
                                <button onClick={() => setClientDetails(null)} className="bg-light-grey-custom hover:bg-primary-dark text-primary-dark hover:text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105">Fechar Detalhes</button>
                            </div>
                        </div>
                    )}

                    <div className="overflow-x-auto rounded-lg shadow">
                        <table className="min-w-full bg-white">
                            <thead className="bg-light-grey-custom">
                                <tr>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">ID</th>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Nome</th>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">NIF</th>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Tipo</th>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Comercial</th>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">RGPD</th>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredClients.map(client => (
                                    <tr key={client.id} className="border-b border-gray-200 hover:bg-gray-50">
                                        <td className="py-3 px-4 text-sm text-gray-700">{client.id_cliente}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{client.nome}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{client.nif}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{client.tipo_cliente}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{getComercialName(client.id_comercial_responsavel)}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{client.rgpd_assinado ? '✅' : '❌'}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700 flex space-x-2">
                                            <button onClick={() => viewDetails(client)} className="bg-accent-beige hover:bg-primary-dark text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 transform hover:scale-105">Ver Detalhes</button>
                                            {(currentUserRole === 'Admin' || currentUserRole === 'Comercial') && (
                                                <>
                                                    <button onClick={() => startEdit(client)} className="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 transform hover:scale-105">Editar</button>
                                                    <button onClick={() => deleteClient(client.id)} className="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 transform hover:scale-105">Eliminar</button>
                                                </>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </section>
            );
        };

        // Componente Gestão de Contratos
        const ContractManagement = ({ contratos, addContract, updateContract, deleteContract, clientes, fornecedores, financeiras, companhiasSeguros, utilizadores, currentUserRole, showAppModal, detalhesCredito, detalhesSeguro, detalhesLegalizacaoConsultoria, interacoes, addInteraction }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [filterType, setFilterType] = useState('');
            const [filterStatus, setFilterStatus] = useState('');
            const [editingContract, setEditingContract] = useState(null);
            const [showContractForm, setShowContractForm] = useState(false);
            const [contractDetails, setContractDetails] = useState(null);
            const [newInteractionData, setNewInteractionData] = useState({ tipo_interacao: 'Chamada', observacoes: '' });

            const [newContractData, setNewContractData] = useState({
                id_cliente: '', id_comercial: '', tipo_servico: 'Crédito', data_inicio: '', data_fim: '', estado: 'Pendente', observacoes: '',
                // Detalhes específicos
                id_financeira: '', id_fornecedor: '', valor_financiado: '', prazo_meses: '', comissao_financeira: '', comissao_fornecedor: '', documentos_em_falta: false, lista_documentos_em_falta: '', credito_realizado: false, data_realizacao: '',
                id_companhia: '', tipo_seguro: '', valor_premio: '', freelancer: false, mediador: '', renovacao_automatica: false, data_renovacao: '',
                tipo_processo: '', estado_processo: '', honorarios: '', documentos_necessarios: ''
            });

            const handleInputChange = (e) => {
                const { name, value, type, checked } = e.target;
                setNewContractData(prev => ({
                    ...prev,
                    [name]: type === 'checkbox' ? checked : value
                }));
            };

            const handleInteractionChange = (e) => {
                const { name, value } = e.target;
                setNewInteractionData(prev => ({ ...prev, [name]: value }));
            };

            const handleAddInteraction = async (contractId) => {
                if (!newInteractionData.observacoes.trim()) {
                    showAppModal('Atenção', 'Por favor, adicione uma observação para a interação.');
                    return;
                }
                const currentUserId = window.auth.currentUser?.uid || 'anonymous'; // Obter o ID do utilizador logado
                await addInteraction({
                    id_cliente: null, // Interação específica do contrato, não do cliente
                    id_contrato: contractId,
                    tipo_interacao: newInteractionData.tipo_interacao,
                    observacoes: newInteractionData.observacoes,
                    id_utilizador: currentUserId
                });
                setNewInteractionData({ tipo_interacao: 'Chamada', observacoes: '' });
                showAppModal('Sucesso', 'Interação registada com sucesso!');
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (editingContract) {
                    await updateContract({ ...newContractData, id: editingContract.id });
                } else {
                    await addContract(newContractData);
                }
                setNewContractData({ id_cliente: '', id_comercial: '', tipo_servico: 'Crédito', data_inicio: '', data_fim: '', estado: 'Pendente', observacoes: '', id_financeira: '', id_fornecedor: '', valor_financiado: '', prazo_meses: '', comissao_financeira: '', comissao_fornecedor: '', documentos_em_falta: false, lista_documentos_em_falta: '', credito_realizado: false, data_realizacao: '', id_companhia: '', tipo_seguro: '', valor_premio: '', freelancer: false, mediador: '', renovacao_automatica: false, data_renovacao: '', tipo_processo: '', estado_processo: '', honorarios: '', documentos_necessarios: '' });
                setEditingContract(null);
                setShowContractForm(false);
            };

            const startEdit = (contract) => {
                const details = detalhesCredito.find(d => d.id_contrato === contract.id_contrato) ||
                               detalhesSeguro.find(d => d.id_contrato === contract.id_contrato) ||
                               detalhesLegalizacaoConsultoria.find(d => d.id_contrato === contract.id_contrato);
                setEditingContract(contract);
                setNewContractData({ ...contract, ...details });
                setShowContractForm(true);
                setContractDetails(null);
            };

            const viewDetails = (contract) => {
                const details = detalhesCredito.find(d => d.id_contrato === contract.id_contrato) ||
                               detalhesSeguro.find(d => d.id_contrato === contract.id_contrato) ||
                               detalhesLegalizacaoConsultoria.find(d => d.id_contrato === contract.id_contrato);
                setContractDetails({ ...contract, details });
                setShowContractForm(false);
            };

            const filteredContratos = contratos.filter(contract => {
                const matchesSearch = contract.id_contrato.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                      clientes.find(c => c.id_cliente === contract.id_cliente)?.nome.toLowerCase().includes(searchTerm.toLowerCase());
                const matchesType = filterType === '' || contract.tipo_servico === filterType;
                const matchesStatus = filterStatus === '' || contract.estado === filterStatus;
                return matchesSearch && matchesType && matchesStatus;
            });

            const getClientName = (id) => clientes.find(c => c.id_cliente === id)?.nome || 'N/A';
            const getComercialName = (id) => utilizadores.find(u => u.id_utilizador === id)?.nome || 'N/A';
            const getFinanceiraName = (id) => financeiras.find(f => f.id_financeira === id)?.nome || 'N/A';
            const getFornecedorName = (id) => fornecedores.find(f => f.id_fornecedor === id)?.nome || 'N/A';
            const getCompanhiaName = (id) => companhiasSeguros.find(c => c.id_companhia === id)?.nome || 'N/A';
            const getUserName = (id) => {
                const user = utilizadores.find(u => u.id_utilizador === id);
                return user ? user.nome : 'N/A';
            };

            const getContractInteractions = (contractId) => {
                return interacoes.filter(i => i.id_contrato === contractId).sort((a, b) => new Date(b.data_interacao) - new Date(a.data_interacao));
            };

            const sendEmailToSupplier = (contract) => {
                const creditDetails = detalhesCredito.find(d => d.id_contrato === contract.id_contrato);
                const supplier = fornecedores.find(f => f.id_fornecedor === creditDetails?.id_fornecedor);
                const client = clientes.find(c => c.id_cliente === contract.id_cliente);

                if (!supplier || !client || !creditDetails || !creditDetails.lista_documentos_em_falta) {
                    showAppModal('Erro', 'Dados insuficientes para enviar o email ao fornecedor.');
                    return;
                }

                const emailSubject = `Documentos em Falta para o Contrato ${contract.id_contrato} - Cliente ${client.nome}`;
                const emailBody = `Prezado(a) ${supplier.nome},\n\n` +
                                  `Gostaríamos de solicitar os seguintes documentos em falta para o contrato de crédito ${contract.id_contrato} do cliente ${client.nome}:\n\n` +
                                  `- ${creditDetails.lista_documentos_em_falta.split(',').join('\n- ')}\n\n` +
                                  `Agradecemos a sua atenção e colaboração.\n\n` +
                                  `Com os melhores cumprimentos,\nEquipa THE WAY`;

                showAppModal(
                    'Simulação de Envio de Email',
                    `Para: ${supplier.email}\nAssunto: ${emailSubject}\n\n${emailBody}\n\n(Este é um email simulado. Nenhuma mensagem foi realmente enviada.)`
                );
            };


            return (
                <section className="bg-white p-8 rounded-xl shadow-md mb-12">
                    <h2 className="text-3xl font-bold text-primary-dark mb-6 text-center">Gestão de Contratos</h2>
                    <p className="text-gray-700 mb-8 text-center">
                        Aqui pode gerir todos os contratos dos seus clientes, filtrando por tipo de serviço, estado e outros critérios.
                    </p>

                    <div className="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div className="flex-grow flex flex-col sm:flex-row gap-4 w-full sm:w-auto">
                            <input
                                type="text"
                                placeholder="Pesquisar por ID ou Cliente..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="p-2 border border-light-grey-custom rounded-lg w-full sm:w-64 focus:outline-none focus:ring-2 focus:ring-accent-beige"
                            />
                            <select
                                value={filterType}
                                onChange={(e) => setFilterType(e.target.value)}
                                className="p-2 border border-light-grey-custom rounded-lg w-full sm:w-48 focus:outline-none focus:ring-2 focus:ring-accent-beige"
                            >
                                <option value="">Todos os Tipos</option>
                                <option value="Crédito">Crédito</option>
                                <option value="Seguro">Seguro</option>
                                <option value="Legalização">Legalização</option>
                                <option value="Consultoria">Consultoria</option>
                            </select>
                            <select
                                value={filterStatus}
                                onChange={(e) => setFilterStatus(e.target.value)}
                                className="p-2 border border-light-grey-custom rounded-lg w-full sm:w-48 focus:outline-none focus:ring-2 focus:ring-accent-beige"
                            >
                                <option value="">Todos os Estados</option>
                                <option value="Pendente">Pendente</option>
                                <option value="Ativo">Ativo</option>
                                <option value="Fechado">Fechado</option>
                                <option value="Cancelado">Cancelado</option>
                            </select>
                        </div>
                        {currentUserRole !== 'Colaborador' && (
                            <button
                                onClick={() => { setShowContractForm(true); setEditingContract(null); setNewContractData({ id_cliente: '', id_comercial: '', tipo_servico: 'Crédito', data_inicio: '', data_fim: '', estado: 'Pendente', observacoes: '', id_financeira: '', id_fornecedor: '', valor_financiado: '', prazo_meses: '', comissao_financeira: '', comissao_fornecedor: '', documentos_em_falta: false, lista_documentos_em_falta: '', credito_realizado: false, data_realizacao: '', id_companhia: '', tipo_seguro: '', valor_premio: '', freelancer: false, mediador: '', renovacao_automatica: false, data_renovacao: '', tipo_processo: '', estado_processo: '', honorarios: '', documentos_necessarios: '' }); setContractDetails(null); }}
                                className="bg-accent-beige hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105 w-full sm:w-auto"
                            >
                                Adicionar Novo Contrato
                            </button>
                        )}
                    </div>

                    {showContractForm && (
                        <div className="bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
                            <h3 className="text-2xl font-bold text-primary-dark mb-4">{editingContract ? 'Editar Contrato' : 'Novo Contrato'}</h3>
                            <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label className="block">
                                    <span className="text-gray-700">Cliente:</span>
                                    <select name="id_cliente" value={newContractData.id_cliente} onChange={handleInputChange} required className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2">
                                        <option value="">Selecionar Cliente</option>
                                        {clientes.map(c => (
                                            <option key={c.id} value={c.id_cliente}>{c.nome}</option>
                                        ))}
                                    </select>
                                </label>
                                <label className="block">
                                    <span className="text-gray-700">Comercial:</span>
                                    <select name="id_comercial" value={newContractData.id_comercial} onChange={handleInputChange} required className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2">
                                        <option value="">Selecionar Comercial</option>
                                        {utilizadores.filter(u => u.role === 'Comercial' || u.role === 'Admin').map(u => (
                                            <option key={u.id} value={u.id_utilizador}>{u.nome}</option>
                                        ))}
                                    </select>
                                </label>
                                <label className="block">
                                    <span className="text-gray-700">Tipo de Serviço:</span>
                                    <select name="tipo_servico" value={newContractData.tipo_servico} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2">
                                        <option value="Crédito">Crédito</option>
                                        <option value="Seguro">Seguro</option>
                                        <option value="Legalização">Legalização</option>
                                        <option value="Consultoria">Consultoria</option>
                                    </select>
                                </label>
                                <label className="block">
                                    <span className="text-gray-700">Estado:</span>
                                    <select name="estado" value={newContractData.estado} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2">
                                        <option value="Pendente">Pendente</option>
                                        <option value="Ativo">Ativo</option>
                                        <option value="Fechado">Fechado</option>
                                        <option value="Cancelado">Cancelado</option>
                                    </select>
                                </label>
                                <label className="block">
                                    <span className="text-gray-700">Data de Início:</span>
                                    <input type="date" name="data_inicio" value={newContractData.data_inicio} onChange={handleInputChange} required className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2" />
                                </label>
                                <label className="block">
                                    <span className="text-gray-700">Data de Fim (se aplicável):</span>
                                    <input type="date" name="data_fim" value={newContractData.data_fim} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2" />
                                </label>

                                {/* Campos específicos por tipo de serviço */}
                                {newContractData.tipo_servico === 'Crédito' && (
                                    <>
                                        <h4 className="col-span-2 text-lg font-semibold text-primary-dark mt-4 mb-2">Detalhes de Crédito</h4>
                                        <label className="block">
                                            <span className="text-gray-700">Financeira:</span>
                                            <select name="id_financeira" value={newContractData.id_financeira} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2">
                                                <option value="">Selecionar Financeira</option>
                                                {financeiras.map(f => <option key={f.id} value={f.id_financeira}>{f.nome}</option>)}
                                            </select>
                                        </label>
                                        <label className="block">
                                            <span className="text-gray-700">Fornecedor:</span>
                                            <select name="id_fornecedor" value={newContractData.id_fornecedor} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2">
                                                <option value="">Selecionar Fornecedor</option>
                                                {fornecedores.map(f => <option key={f.id} value={f.id_fornecedor}>{f.nome}</option>)}
                                            </select>
                                        </label>
                                        <label className="block">
                                            <span className="text-gray-700">Valor:</span>
                                            <input type="number" name="valor_financiado" value={newContractData.valor_financiado} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2" />
                                        </label>
                                        <label className="block">
                                            <span className="text-gray-700">Prazo (meses):</span>
                                            <input type="number" name="prazo_meses" value={newContractData.prazo_meses} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2" />
                                        </label>
                                        <label className="block">
                                            <span className="text-gray-700">Comissão Financeira:</span>
                                            <input type="number" name="comissao_financeira" value={newContractData.comissao_financeira} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2" />
                                        </label>
                                        <label className="block">
                                            <span className="text-gray-700">Comissão Fornecedor:</span>
                                            <input type="number" name="comissao_fornecedor" value={newContractData.comissao_fornecedor} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2" />
                                        </label>
                                        <label className="flex items-center mt-2 col-span-1">
                                            <input type="checkbox" name="documentos_em_falta" checked={newContractData.documentos_em_falta} onChange={handleInputChange} className="form-checkbox h-5 w-5 text-accent-beige rounded" />
                                            <span className="ml-2 text-gray-700">Documentos em Falta</span>
                                        </label>
                                        {newContractData.documentos_em_falta && (
                                            <label className="block col-span-1">
                                                <span className="text-gray-700">Lista de Documentos em Falta:</span>
                                                <input type="text" name="lista_documentos_em_falta" value={newContractData.lista_documentos_em_falta} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2" />
                                            </label>
                                        )}
                                        <label className="flex items-center mt-2 col-span-1">
                                            <input type="checkbox" name="credito_realizado" checked={newContractData.credito_realizado} onChange={handleInputChange} className="form-checkbox h-5 w-5 text-accent-beige rounded" />
                                            <span className="ml-2 text-gray-700">Crédito Realizado</span>
                                        </label>
                                        {newContractData.credito_realizado && (
                                            <label className="block col-span-1">
                                                <span className="text-gray-700">Data de Realização:</span>
                                                <input type="date" name="data_realizacao" value={newContractData.data_realizacao} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2" />
                                            </label>
                                        )}
                                    </>
                                )}

                                {newContractData.tipo_servico === 'Seguro' && (
                                    <>
                                        <h4 className="col-span-2 text-lg font-semibold text-primary-dark mt-4 mb-2">Detalhes de Seguro</h4>
                                        <label className="block">
                                            <span className="text-gray-700">Companhia:</span>
                                            <select name="id_companhia" value={newContractData.id_companhia} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2">
                                                <option value="">Selecionar Companhia</option>
                                                {companhiasSeguros.map(c => <option key={c.id} value={c.id_companhia}>{c.nome}</option>)}
                                            </select>
                                        </label>
                                        <label className="block">
                                            <span className="text-gray-700">Tipo de Seguro:</span>
                                            <input type="text" name="tipo_seguro" value={newContractData.tipo_seguro} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2" />
                                        </label>
                                        <label className="block">
                                            <span className="text-gray-700">Valor Prémio:</span>
                                            <input type="number" name="valor_premio" value={newContractData.valor_premio} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2" />
                                        </label>
                                        <label className="block">
                                            <span className="text-gray-700">Mediador:</span>
                                            <input type="text" name="mediador" value={newContractData.mediador} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2" />
                                        </label>
                                        <label className="flex items-center mt-2 col-span-1">
                                            <input type="checkbox" name="freelancer" checked={newContractData.freelancer} onChange={handleInputChange} className="form-checkbox h-5 w-5 text-accent-beige rounded" />
                                            <span className="ml-2 text-gray-700">Freelancer</span>
                                        </label>
                                        <label className="flex items-center mt-2 col-span-1">
                                            <input type="checkbox" name="renovacao_automatica" checked={newContractData.renovacao_automatica} onChange={handleInputChange} className="form-checkbox h-5 w-5 text-accent-beige rounded" />
                                            <span className="ml-2 text-gray-700">Renovação Automática</span>
                                        </label>
                                        {newContractData.renovacao_automatica && (
                                            <label className="block col-span-2">
                                                <span className="text-gray-700">Data de Renovação:</span>
                                                <input type="date" name="data_renovacao" value={newContractData.data_renovacao} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2" />
                                            </label>
                                        )}
                                    </>
                                )}

                                {(newContractData.tipo_servico === 'Legalização' || newContractData.tipo_servico === 'Consultoria') && (
                                    <>
                                        <h4 className="col-span-2 text-lg font-semibold text-primary-dark mt-4 mb-2">Detalhes de Legalização/Consultoria</h4>
                                        <label className="block">
                                            <span className="text-gray-700">Tipo de Processo:</span>
                                            <input type="text" name="tipo_processo" value={newContractData.tipo_processo} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2" />
                                        </label>
                                        <label className="block">
                                            <span className="text-gray-700">Estado do Processo:</span>
                                            <input type="text" name="estado_processo" value={newContractData.estado_processo} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2" />
                                        </label>
                                        <label className="block">
                                            <span className="text-gray-700">Honorários:</span>
                                            <input type="number" name="honorarios" value={newContractData.honorarios} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2" />
                                        </label>
                                        <label className="block">
                                            <span className="text-gray-700">Documentos Necessários:</span>
                                            <input type="text" name="documentos_necessarios" value={newContractData.documentos_necessarios} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2" />
                                        </label>
                                    </>
                                )}
                                <label className="block col-span-1 md:col-span-2">
                                    <span className="text-gray-700">Observações Gerais:</span>
                                    <textarea name="observacoes" value={newContractData.observacoes} onChange={handleInputChange} rows="3" className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2"></textarea>
                                </label>
                                <div className="col-span-1 md:col-span-2 flex justify-end space-x-4 mt-4">
                                    <button type="button" onClick={() => setShowContractForm(false)} className="bg-light-grey-custom hover:bg-primary-dark text-primary-dark hover:text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105">Cancelar</button>
                                    <button type="submit" className="bg-accent-beige hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105">
                                        {editingContract ? 'Atualizar Contrato' : 'Adicionar Contrato'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}

                    {contractDetails && (
                        <div className="bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
                            <h3 className="text-2xl font-bold text-primary-dark mb-4">Detalhes do Contrato: {contractDetails.id_contrato}</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700 mb-6">
                                <p><strong>Cliente:</strong> {getClientName(contractDetails.id_cliente)}</p>
                                <p><strong>Comercial:</strong> {getComercialName(contractDetails.id_comercial)}</p>
                                <p><strong>Tipo de Serviço:</strong> {contractDetails.tipo_servico}</p>
                                <p><strong>Estado:</strong> {contractDetails.estado}</p>
                                <p><strong>Data de Início:</strong> {contractDetails.data_inicio}</p>
                                <p><strong>Data de Fim:</strong> {contractDetails.data_fim || 'N/A'}</p>
                                <p className="md:col-span-2"><strong>Observações:</strong> {contractDetails.observacoes || 'N/A'}</p>
                            </div>

                            {contractDetails.tipo_servico === 'Crédito' && contractDetails.details && (
                                <>
                                    <h4 className="text-xl font-bold text-primary-dark mb-3">Detalhes de Crédito</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700 mb-6">
                                        <p><strong>Financeira:</strong> {getFinanceiraName(contractDetails.details.id_financeira)}</p>
                                        <p><strong>Fornecedor:</strong> {getFornecedorName(contractDetails.details.id_fornecedor)}</p>
                                        <p><strong>Valor:</strong> {contractDetails.details.valor_financiado?.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' })}</p>
                                        <p><strong>Prazo:</strong> {contractDetails.details.prazo_meses} meses</p>
                                        <p><strong>Comissão Financeira:</strong> {contractDetails.details.comissao_financeira?.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' })}</p>
                                        <p><strong>Comissão Fornecedor:</strong> {contractDetails.details.comissao_fornecedor?.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' })}</p>
                                        <p><strong>Documentos em Falta:</strong> {contractDetails.details.documentos_em_falta ? 'Sim' : 'Não'}</p>
                                        {contractDetails.details.documentos_em_falta && <p><strong>Lista:</strong> {contractDetails.details.lista_documentos_em_falta}</p>}
                                        <p><strong>Crédito Realizado:</strong> {contractDetails.details.credito_realizado ? 'Sim' : 'Não'}</p>
                                        {contractDetails.details.credito_realizado && <p><strong>Data Realização:</strong> {contractDetails.details.data_realizacao}</p>}
                                    </div>
                                    {contractDetails.details.documentos_em_falta && (
                                        <div className="flex justify-end mt-4">
                                            <button
                                                onClick={() => sendEmailToSupplier(contractDetails)}
                                                className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105"
                                            >
                                                Enviar Email ao Fornecedor
                                            </button>
                                        </div>
                                    )}
                                </>
                            )}
                            {contractDetails.tipo_servico === 'Seguro' && contractDetails.details && (
                                <>
                                    <h4 className="text-xl font-bold text-primary-dark mb-3">Detalhes de Seguro</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700 mb-6">
                                        <p><strong>Companhia:</strong> {getCompanhiaName(contractDetails.details.id_companhia)}</p>
                                        <p><strong>Tipo de Seguro:</strong> {contractDetails.details.tipo_seguro}</p>
                                        <p><strong>Valor Prémio:</strong> {contractDetails.details.valor_premio?.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' })}</p>
                                        <p><strong>Mediador:</strong> {contractDetails.details.mediador}</p>
                                        <p><strong>Freelancer:</strong> {contractDetails.details.freelancer ? 'Sim' : 'Não'}</p>
                                        <p><strong>Renovação Automática:</strong> {contractDetails.details.renovacao_automatica ? 'Sim' : 'Não'}</p>
                                        {contractDetails.details.renovacao_automatica && <p><strong>Data Renovação:</strong> {contractDetails.details.data_renovacao}</p>}
                                    </div>
                                </>
                            )}
                            {(contractDetails.tipo_servico === 'Legalização' || contractDetails.tipo_servico === 'Consultoria') && contractDetails.details && (
                                <>
                                    <h4 className="text-xl font-bold text-primary-dark mb-3">Detalhes de Legalização/Consultoria</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700 mb-6">
                                        <p><strong>Tipo de Processo:</strong> {contractDetails.details.tipo_processo}</p>
                                        <p><strong>Estado do Processo:</strong> {contractDetails.details.estado_processo}</p>
                                        <p><strong>Honorários:</strong> {contractDetails.details.honorarios?.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' })}</p>
                                        <p className="md:col-span-2"><strong>Documentos Necessários:</strong> {contractDetails.details.documentos_necessarios || 'N/A'}</p>
                                    </div>
                                </>
                            )}

                            <h4 className="text-xl font-bold text-primary-dark mb-3 mt-6">Histórico de Interações</h4>
                            <div className="bg-white p-4 rounded-lg shadow-sm mb-4">
                                <h5 className="text-lg font-semibold text-primary-dark mb-2">Adicionar Nova Interação</h5>
                                <div className="flex flex-col md:flex-row gap-3 items-end">
                                    <div className="flex-grow">
                                        <label className="block text-gray-700 text-sm">Tipo de Interação:</label>
                                        <select
                                            name="tipo_interacao"
                                            value={newInteractionData.tipo_interacao}
                                            onChange={handleInteractionChange}
                                            className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2"
                                        >
                                            <option value="Chamada">Chamada</option>
                                            <option value="Email">Email</option>
                                            <option value="Reunião">Reunião</option>
                                            <option value="Nota">Nota</option>
                                        </select>
                                    </div>
                                    <div className="flex-grow-[2]">
                                        <label className="block text-gray-700 text-sm">Observações:</label>
                                        <textarea
                                            name="observacoes"
                                            value={newInteractionData.observacoes}
                                            onChange={handleInteractionChange}
                                            rows="2"
                                            className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2"
                                            placeholder="Descreva a interação..."
                                        ></textarea>
                                    </div>
                                    <button
                                        onClick={() => handleAddInteraction(contractDetails.id_contrato)}
                                        className="bg-accent-beige hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg text-sm transition duration-300 transform hover:scale-105"
                                    >
                                        Registar
                                    </button>
                                </div>
                            </div>
                            {getContractInteractions(contractDetails.id_contrato).length > 0 ? (
                                <div className="overflow-x-auto rounded-lg shadow">
                                    <table className="min-w-full bg-white">
                                        <thead className="bg-light-grey-custom">
                                            <tr>
                                                <th className="py-2 px-3 text-left text-xs font-semibold text-primary-dark">Data</th>
                                                <th className="py-2 px-3 text-left text-xs font-semibold text-primary-dark">Tipo</th>
                                                <th className="py-2 px-3 text-left text-xs font-semibold text-primary-dark">Observações</th>
                                                <th className="py-2 px-3 text-left text-xs font-semibold text-primary-dark">Utilizador</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {getContractInteractions(contractDetails.id_contrato).map(interaction => (
                                                <tr key={interaction.id} className="border-b border-gray-200 hover:bg-gray-50">
                                                    <td className="py-2 px-3 text-sm text-gray-700">{new Date(interaction.data_interacao).toLocaleString('pt-PT')}</td>
                                                    <td className="py-2 px-3 text-sm text-gray-700">{interaction.tipo_interacao}</td>
                                                    <td className="py-2 px-3 text-sm text-gray-700">{interaction.observacoes}</td>
                                                    <td className="py-2 px-3 text-sm text-gray-700">{getUserName(interaction.id_utilizador)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            ) : (
                                <p className="text-gray-600">Nenhuma interação registada para este contrato.</p>
                            )}

                            <div className="flex justify-end mt-6">
                                <button onClick={() => setContractDetails(null)} className="bg-light-grey-custom hover:bg-primary-dark text-primary-dark hover:text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105">Fechar Detalhes</button>
                            </div>
                        </div>
                    )}

                    <div className="overflow-x-auto rounded-lg shadow">
                        <table className="min-w-full bg-white">
                            <thead className="bg-light-grey-custom">
                                <tr>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">ID Contrato</th>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Cliente</th>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Tipo Serviço</th>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Estado</th>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Comercial</th>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Início</th>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredContratos.map(contract => (
                                    <tr key={contract.id} className="border-b border-gray-200 hover:bg-gray-50">
                                        <td className="py-3 px-4 text-sm text-gray-700">{contract.id_contrato}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{getClientName(contract.id_cliente)}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{contract.tipo_servico}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{contract.estado}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{getComercialName(contract.id_comercial)}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{contract.data_inicio}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700 flex space-x-2">
                                            <button onClick={() => viewDetails(contract)} className="bg-accent-beige hover:bg-primary-dark text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 transform hover:scale-105">Ver Detalhes</button>
                                            {(currentUserRole === 'Admin' || currentUserRole === 'Comercial') && (
                                                <>
                                                    <button onClick={() => startEdit(contract)} className="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 transform hover:scale-105">Editar</button>
                                                    <button onClick={() => deleteContract(contract.id)} className="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 transform hover:scale-105">Eliminar</button>
                                                </>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </section>
            );
        };

        // Componente Gestão de Tarefas
        const TaskManagement = ({ tarefas, addTask, updateTask, deleteTask, clientes, contratos, utilizadores, currentUserRole, showAppModal }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [filterStatus, setFilterStatus] = useState('');
            const [filterPriority, setFilterPriority] = useState('');
            const [editingTask, setEditingTask] = useState(null);
            const [showTaskForm, setShowTaskForm] = useState(false);

            const [newTaskData, setNewTaskData] = useState({
                titulo: '', descricao: '', data_vencimento: '', estado: 'Pendente', prioridade: 'Média', id_cliente: '', id_contrato: '', id_utilizador_responsavel: ''
            });

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setNewTaskData(prev => ({
                    ...prev,
                    [name]: value
                }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (editingTask) {
                    await updateTask({ ...newTaskData, id: editingTask.id });
                } else {
                    await addTask(newTaskData);
                }
                setNewTaskData({ titulo: '', descricao: '', data_vencimento: '', estado: 'Pendente', prioridade: 'Média', id_cliente: '', id_contrato: '', id_utilizador_responsavel: '' });
                setEditingTask(null);
                setShowTaskForm(false);
            };

            const startEdit = (task) => {
                setEditingTask(task);
                setNewTaskData({ ...task });
                setShowTaskForm(true);
            };

            const markAsComplete = async (task) => {
                showAppModal('Concluir Tarefa', `Tem a certeza que quer marcar a tarefa "${task.titulo}" como concluída?`, async () => {
                    await updateTask({ ...task, estado: 'Concluída' });
                    showAppModal('Sucesso', 'Tarefa marcada como concluída!');
                });
            };

            const filteredTasks = tarefas.filter(task => {
                const matchesSearch = task.titulo.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                      task.descricao.toLowerCase().includes(searchTerm.toLowerCase());
                const matchesStatus = filterStatus === '' || task.estado === filterStatus;
                const matchesPriority = filterPriority === '' || task.prioridade === filterPriority;
                return matchesSearch && matchesStatus && matchesPriority;
            });

            const getClientName = (id) => clientes.find(c => c.id_cliente === id)?.nome || 'N/A';
            const getContractId = (id) => contratos.find(c => c.id_contrato === id)?.id_contrato || 'N/A';
            const getComercialName = (id) => utilizadores.find(u => u.id_utilizador === id)?.nome || 'N/A';

            return (
                <section className="bg-white p-8 rounded-xl shadow-md mb-12">
                    <h2 className="text-3xl font-bold text-primary-dark mb-6 text-center">Gestão de Tarefas</h2>
                    <p className="text-gray-700 mb-8 text-center">
                        Esta secção permite criar, gerir e acompanhar todas as tarefas relacionadas com clientes e contratos.
                    </p>

                    <div className="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div className="flex-grow flex flex-col sm:flex-row gap-4 w-full sm:w-auto">
                            <input
                                type="text"
                                placeholder="Pesquisar por título ou descrição..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="p-2 border border-light-grey-custom rounded-lg w-full sm:w-64 focus:outline-none focus:ring-2 focus:ring-accent-beige"
                            />
                            <select
                                value={filterStatus}
                                onChange={(e) => setFilterStatus(e.target.value)}
                                className="p-2 border border-light-grey-custom rounded-lg w-full sm:w-48 focus:outline-none focus:ring-2 focus:ring-accent-beige"
                            >
                                <option value="">Todos os Estados</option>
                                <option value="Pendente">Pendente</option>
                                <option value="Concluída">Concluída</option>
                            </select>
                            <select
                                value={filterPriority}
                                onChange={(e) => setFilterPriority(e.target.value)}
                                className="p-2 border border-light-grey-custom rounded-lg w-full sm:w-48 focus:outline-none focus:ring-2 focus:ring-accent-beige"
                            >
                                <option value="">Todas as Prioridades</option>
                                <option value="Baixa">Baixa</option>
                                <option value="Média">Média</option>
                                <option value="Alta">Alta</option>
                            </select>
                        </div>
                        {currentUserRole !== 'Colaborador' && (
                            <button
                                onClick={() => { setShowTaskForm(true); setEditingTask(null); setNewTaskData({ titulo: '', descricao: '', data_vencimento: '', estado: 'Pendente', prioridade: 'Média', id_cliente: '', id_contrato: '', id_utilizador_responsavel: '' }); }}
                                className="bg-accent-beige hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105 w-full sm:w-auto"
                            >
                                Adicionar Nova Tarefa
                            </button>
                        )}
                    </div>

                    {showTaskForm && (
                        <div className="bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
                            <h3 className="text-2xl font-bold text-primary-dark mb-4">{editingTask ? 'Editar Tarefa' : 'Nova Tarefa'}</h3>
                            <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label className="block col-span-1 md:col-span-2">
                                    <span className="text-gray-700">Título:</span>
                                    <input type="text" name="titulo" value={newTaskData.titulo} onChange={handleInputChange} required className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2" />
                                </label>
                                <label className="block col-span-1 md:col-span-2">
                                    <span className="text-gray-700">Descrição:</span>
                                    <textarea name="descricao" value={newTaskData.descricao} onChange={handleInputChange} rows="3" className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2"></textarea>
                                </label>
                                <label className="block">
                                    <span className="text-gray-700">Data de Vencimento:</span>
                                    <input type="date" name="data_vencimento" value={newTaskData.data_vencimento} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2" />
                                </label>
                                <label className="block">
                                    <span className="text-gray-700">Estado:</span>
                                    <select name="estado" value={newTaskData.estado} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2">
                                        <option value="Pendente">Pendente</option>
                                        <option value="Concluída">Concluída</option>
                                    </select>
                                </label>
                                <label className="block">
                                    <span className="text-gray-700">Prioridade:</span>
                                    <select name="prioridade" value={newTaskData.prioridade} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2">
                                        <option value="Baixa">Baixa</option>
                                        <option value="Média">Média</option>
                                        <option value="Alta">Alta</option>
                                    </select>
                                </label>
                                <label className="block">
                                    <span className="text-gray-700">Cliente Associado (Opcional):</span>
                                    <select name="id_cliente" value={newTaskData.id_cliente} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2">
                                        <option value="">Nenhum</option>
                                        {clientes.map(c => (
                                            <option key={c.id} value={c.id_cliente}>{c.nome}</option>
                                        ))}
                                    </select>
                                </label>
                                <label className="block">
                                    <span className="text-gray-700">Contrato Associado (Opcional):</span>
                                    <select name="id_contrato" value={newTaskData.id_contrato} onChange={handleInputChange} className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2">
                                        <option value="">Nenhum</option>
                                        {contratos.map(c => (
                                            <option key={c.id} value={c.id_contrato}>{c.id_contrato} - {getClientName(c.id_cliente)}</option>
                                        ))}
                                    </select>
                                </label>
                                <label className="block">
                                    <span className="text-gray-700">Responsável:</span>
                                    <select name="id_utilizador_responsavel" value={newTaskData.id_utilizador_responsavel} onChange={handleInputChange} required className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2">
                                        <option value="">Selecionar Responsável</option>
                                        {utilizadores.filter(u => u.role === 'Comercial' || u.role === 'Admin').map(u => (
                                            <option key={u.id} value={u.id_utilizador}>{u.nome}</option>
                                        ))}
                                    </select>
                                </label>
                                <div className="col-span-1 md:col-span-2 flex justify-end space-x-4 mt-4">
                                    <button type="button" onClick={() => setShowTaskForm(false)} className="bg-light-grey-custom hover:bg-primary-dark text-primary-dark hover:text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105">Cancelar</button>
                                    <button type="submit" className="bg-accent-beige hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105">
                                        {editingTask ? 'Atualizar Tarefa' : 'Adicionar Tarefa'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}

                    <div className="overflow-x-auto rounded-lg shadow">
                        <table className="min-w-full bg-white">
                            <thead className="bg-light-grey-custom">
                                <tr>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">ID Tarefa</th>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Título</th>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Prioridade</th>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Estado</th>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Vencimento</th>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Responsável</th>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Cliente</th>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Contrato</th>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredTasks.map(task => (
                                    <tr key={task.id} className="border-b border-gray-200 hover:bg-gray-50">
                                        <td className="py-3 px-4 text-sm text-gray-700">{task.id_tarefa}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{task.titulo}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{task.prioridade}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{task.estado}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{task.data_vencimento}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{getComercialName(task.id_utilizador_responsavel)}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{task.id_cliente ? getClientName(task.id_cliente) : 'N/A'}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{task.id_contrato ? getContractId(task.id_contrato) : 'N/A'}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700 flex space-x-2">
                                            {(currentUserRole === 'Admin' || currentUserRole === 'Comercial') && (
                                                <>
                                                    {task.estado === 'Pendente' && (
                                                        <button onClick={() => markAsComplete(task)} className="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 transform hover:scale-105">Concluir</button>
                                                    )}
                                                    <button onClick={() => startEdit(task)} className="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 transform hover:scale-105">Editar</button>
                                                    <button onClick={() => deleteTask(task.id)} className="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 transform hover:scale-105">Eliminar</button>
                                                </>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </section>
            );
        };


        // Componente Gestão de Fornecedores/Financeiras/Companhias (simplificado)
        const SuppliersFinancialsManagement = ({ fornecedores, financeiras, companhiasSeguros, addEntity, updateEntity, deleteEntity, showAppModal }) => {
            const [activeSubTab, setActiveSubTab] = useState('fornecedores');
            const [editingEntity, setEditingEntity] = useState(null); // Para guardar a entidade que está a ser editada
            const [newEntityData, setNewEntityData] = useState({
                nome: '',
                nif: '', // Only for fornecedores
                contacto: '',
                email: '',
                morada: '' // Only for fornecedores
            });

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setNewEntityData(prev => ({
                    ...prev,
                    [name]: value
                }));
            };

            const resetNewEntityData = () => {
                setNewEntityData({
                    nome: '',
                    nif: '',
                    contacto: '',
                    email: '',
                    morada: ''
                });
                setEditingEntity(null); // Limpa a entidade em edição
            };

            const startEdit = (entity, type) => {
                setEditingEntity({ ...entity, type }); // Guarda a entidade e o seu tipo
                setNewEntityData({ ...entity }); // Preenche o formulário com os dados da entidade
            };

            const handleSubmit = async () => {
                if (editingEntity) {
                    // Se estiver a editar, usa a função de atualização
                    await updateEntity(editingEntity.type, editingEntity.id, newEntityData);
                } else {
                    // Caso contrário, adiciona uma nova entidade
                    await addEntity(activeSubTab, newEntityData);
                }
                resetNewEntityData(); // Limpa o formulário e o estado de edição
            };

            return (
                <section className="bg-white p-8 rounded-xl shadow-md mb-12">
                    <h2 className="text-3xl font-bold text-primary-dark mb-6 text-center">Gestão de Fornecedores, Financeiras e Companhias</h2>
                    <p className="text-gray-700 mb-8 text-center">
                        Esta secção, acessível apenas para administradores, permite gerir as entidades parceiras da THE WAY.
                    </p>

                    <div className="flex justify-center mb-6 space-x-4">
                        <button onClick={() => { setActiveSubTab('fornecedores'); resetNewEntityData(); }} className={`px-4 py-2 rounded-lg font-bold transition duration-300 ${activeSubTab === 'fornecedores' ? 'bg-accent-beige text-primary-dark' : 'bg-light-grey-custom hover:bg-primary-dark hover:text-white'}`}>Fornecedores</button>
                        <button onClick={() => { setActiveSubTab('financeiras'); resetNewEntityData(); }} className={`px-4 py-2 rounded-lg font-bold transition duration-300 ${activeSubTab === 'financeiras' ? 'bg-accent-beige text-primary-dark' : 'bg-light-grey-custom hover:bg-primary-dark hover:text-white'}`}>Financeiras</button>
                        <button onClick={() => { setActiveSubTab('companhias'); resetNewEntityData(); }} className={`px-4 py-2 rounded-lg font-bold transition duration-300 ${activeSubTab === 'companhias' ? 'bg-accent-beige text-primary-dark' : 'bg-light-grey-custom hover:bg-primary-dark hover:text-white'}`}>Companhias de Seguros</button>
                    </div>

                    <div className="bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
                        <h3 className="text-2xl font-bold text-primary-dark mb-4">
                            {editingEntity ? `Editar ${editingEntity.type.charAt(0).toUpperCase() + editingEntity.type.slice(1)}` : `Adicionar ${activeSubTab === 'fornecedores' ? 'Fornecedor' : activeSubTab === 'financeiras' ? 'Financeira' : 'Companhia'}`}
                        </h3>
                        <div className="flex flex-col gap-4">
                            <input
                                type="text"
                                placeholder={`Nome do ${activeSubTab === 'fornecedores' ? 'Fornecedor' : activeSubTab === 'financeiras' ? 'Financeira' : 'Companhia'}`}
                                name="nome"
                                value={newEntityData.nome}
                                onChange={handleInputChange}
                                className="p-2 border border-light-grey-custom rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-beige"
                            />
                            {(activeSubTab === 'fornecedores' || (editingEntity && editingEntity.type === 'fornecedor')) && (
                                <>
                                    <input
                                        type="text"
                                        placeholder="NIF"
                                        name="nif"
                                        value={newEntityData.nif}
                                        onChange={handleInputChange}
                                        className="p-2 border border-light-grey-custom rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-beige"
                                    />
                                    <input
                                        type="text"
                                        placeholder="Morada"
                                        name="morada"
                                        value={newEntityData.morada}
                                        onChange={handleInputChange}
                                        className="p-2 border border-light-grey-custom rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-beige"
                                    />
                                </>
                            )}
                            <input
                                type="text"
                                placeholder="Contacto"
                                name="contacto"
                                value={newEntityData.contacto}
                                onChange={handleInputChange}
                                className="p-2 border border-light-grey-custom rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-beige"
                            />
                            <input
                                type="email"
                                placeholder="Email"
                                name="email"
                                value={newEntityData.email}
                                onChange={handleInputChange}
                                className="p-2 border border-light-grey-custom rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-beige"
                            />
                            <div className="flex justify-end space-x-4">
                                {editingEntity && (
                                    <button
                                        type="button"
                                        onClick={resetNewEntityData}
                                        className="bg-light-grey-custom hover:bg-primary-dark text-primary-dark hover:text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105"
                                    >
                                        Cancelar Edição
                                    </button>
                                )}
                                <button
                                    onClick={handleSubmit}
                                    className="bg-accent-beige hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105"
                                >
                                    {editingEntity ? 'Atualizar' : 'Adicionar'}
                                </button>
                            </div>
                        </div>
                    </div>

                    <h3 className="text-2xl font-bold text-primary-dark mb-4">Lista de {activeSubTab === 'fornecedores' ? 'Fornecedores' : activeSubTab === 'financeiras' ? 'Financeiras' : 'Companhias'}</h3>
                    <div className="overflow-x-auto rounded-lg shadow">
                        <table className="min-w-full bg-white">
                            <thead className="bg-light-grey-custom">
                                <tr>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">ID</th>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Nome</th>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Contacto</th>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Email</th>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-primary-dark">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {activeSubTab === 'fornecedores' && fornecedores.map(f => (
                                    <tr key={f.id} className="border-b border-gray-200 hover:bg-gray-50">
                                        <td className="py-3 px-4 text-sm text-gray-700">{f.id_fornecedor}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{f.nome}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{f.contacto}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{f.email}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700 flex space-x-2">
                                            <button onClick={() => startEdit(f, 'fornecedor')} className="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 transform hover:scale-105">Editar</button>
                                            <button onClick={() => deleteEntity('fornecedor', f.id)} className="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 transform hover:scale-105">Eliminar</button>
                                        </td>
                                    </tr>
                                ))}
                                {activeSubTab === 'financeiras' && financeiras.map(f => (
                                    <tr key={f.id} className="border-b border-gray-200 hover:bg-gray-50">
                                        <td className="py-3 px-4 text-sm text-gray-700">{f.id_financeira}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{f.nome}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{f.contacto}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{f.email}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700 flex space-x-2">
                                            <button onClick={() => startEdit(f, 'financeira')} className="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 transform hover:scale-105">Editar</button>
                                            <button onClick={() => deleteEntity('financeira', f.id)} className="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 transform hover:scale-105">Eliminar</button>
                                        </td>
                                    </tr>
                                ))}
                                {activeSubTab === 'companhias' && companhiasSeguros.map(c => (
                                    <tr key={c.id} className="border-b border-gray-200 hover:bg-gray-50">
                                        <td className="py-3 px-4 text-sm text-gray-700">{c.id_companhia}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{c.nome}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{c.contacto}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700">{c.email}</td>
                                        <td className="py-3 px-4 text-sm text-gray-700 flex space-x-2">
                                            <button onClick={() => startEdit(c, 'companhia')} className="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 transform hover:scale-105">Editar</button>
                                            <button onClick={() => deleteEntity('companhia', c.id)} className="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 transform hover:scale-105">Eliminar</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </section>
            );
        };

        // Componente Relatório de Produção por Fornecedor
        const SupplierReport = ({ fornecedores, contratos, detalhesCredito, clientes, showAppModal }) => {
            const [selectedSupplierId, setSelectedSupplierId] = useState('');
            const [selectedMonth, setSelectedMonth] = useState('');
            const [reportData, setReportData] = useState(null);

            const availableMonths = Array.from(new Set(
                contratos
                    .filter(c => c.tipo_servico === 'Crédito' && c.data_inicio)
                    .map(c => {
                        const date = new Date(c.data_inicio);
                        return `${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
                    })
            )).sort((a, b) => {
                const [mA, yA] = a.split('/').map(Number);
                const [mB, yB] = b.split('/').map(Number);
                return yA - yB || mA - mB;
            });

            const generateReport = () => {
                if (!selectedSupplierId || !selectedMonth) {
                    showAppModal('Atenção', 'Por favor, selecione um fornecedor e um mês/ano.');
                    return;
                }

                const [monthNum, yearNum] = selectedMonth.split('/').map(Number);
                const supplier = fornecedores.find(f => f.id_fornecedor === selectedSupplierId);

                if (!supplier) {
                    showAppModal('Erro', 'Fornecedor não encontrado.');
                    return;
                }

                const relevantContracts = contratos.filter(c =>
                    c.tipo_servico === 'Crédito' &&
                    new Date(c.data_inicio).getMonth() + 1 === monthNum &&
                    new Date(c.data_inicio).getFullYear() === yearNum
                );

                const creditsForSupplier = relevantContracts.map(contract => {
                    const detail = detalhesCredito.find(dc => dc.id_contrato === contract.id_contrato && dc.id_fornecedor === selectedSupplierId);
                    if (detail) {
                        const client = clientes.find(c => c.id_cliente === contract.id_cliente);
                        return {
                            id_contrato: contract.id_contrato,
                            nome_cliente: client ? client.nome : 'N/A',
                            valor_financiado: detail.valor_financiado,
                            comissao_fornecedor: detail.comissao_fornecedor,
                            data_inicio: contract.data_inicio,
                            estado: contract.estado
                        };
                    }
                    return null;
                }).filter(Boolean); // Remove null entries if no matching detail found

                const totalComissao = creditsForSupplier.reduce((sum, item) => sum + item.comissao_fornecedor, 0);
                const totalComissaoComIVA = totalComissao * 1.23; // Adiciona 23% de IVA

                setReportData({
                    supplier: supplier,
                    month: selectedMonth,
                    credits: creditsForSupplier,
                    totalComissao: totalComissao,
                    totalComissaoComIVA: totalComissaoComIVA
                });
            };

            const printReport = () => {
                window.print();
            };

            return (
                <section className="bg-white p-8 rounded-xl shadow-md mb-12">
                    <h2 className="text-3xl font-bold text-primary-dark mb-6 text-center">Relatórios de Produção</h2>
                    <p className="text-gray-700 mb-8 text-center">
                        Esta secção permite gerar relatórios detalhados da produção de crédito por fornecedor, incluindo comissões e valores totais.
                    </p>

                    <div className="bg-gray-50 p-6 rounded-lg shadow-inner mb-8 flex flex-col sm:flex-row gap-4 items-center justify-center">
                        <label className="block sm:w-1/3">
                            <span className="text-gray-700">Fornecedor:</span>
                            <select
                                value={selectedSupplierId}
                                onChange={(e) => setSelectedSupplierId(e.target.value)}
                                className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2"
                            >
                                <option value="">Selecionar Fornecedor</option>
                                {fornecedores.map(f => (
                                    <option key={f.id} value={f.id_fornecedor}>{f.nome}</option>
                                ))}
                            </select>
                        </label>
                        <label className="block sm:w-1/3">
                            <span className="text-gray-700">Mês/Ano:</span>
                            <select
                                value={selectedMonth}
                                onChange={(e) => setSelectedMonth(e.target.value)}
                                className="mt-1 block w-full rounded-md border-light-grey-custom shadow-sm focus:border-accent-beige focus:ring focus:ring-accent-beige focus:ring-opacity-50 p-2"
                            >
                                <option value="">Selecionar Mês/Ano</option>
                                {availableMonths.map(month => (
                                    <option key={month} value={month}>{month}</option>
                                ))}
                            </select>
                        </label>
                        <button
                            onClick={generateReport}
                            className="bg-accent-beige hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105 mt-4 sm:mt-0"
                        >
                            Gerar Relatório
                        </button>
                    </div>

                    {reportData && (
                        <div className="print-area bg-gray-50 p-6 rounded-lg shadow-inner">
                            <h3 className="text-2xl font-bold text-primary-dark mb-4 text-center">Relatório de Produção - {reportData.supplier.nome} ({reportData.month})</h3>
                            <div className="mb-6 text-gray-700">
                                <p><strong>Fornecedor:</strong> {reportData.supplier.nome}</p>
                                <p><strong>NIF:</strong> {reportData.supplier.nif || 'N/A'}</p>
                                <p><strong>Morada:</strong> {reportData.supplier.morada || 'N/A'}</p>
                                <p><strong>Mês de Referência:</strong> {reportData.month}</p>
                                <p><strong>Contacto:</strong> {reportData.supplier.contacto}</p>
                                <p><strong>Email:</strong> {reportData.supplier.email}</p>
                            </div>

                            <h4 className="text-xl font-bold text-primary-dark mb-3">Créditos Ativos no Mês</h4>
                            {reportData.credits.length > 0 ? (
                                <div className="overflow-x-auto rounded-lg shadow mb-6">
                                    <table className="min-w-full bg-white">
                                        <thead className="bg-light-grey-custom">
                                            <tr>
                                                <th className="py-2 px-3 text-left text-xs font-semibold text-primary-dark">ID Contrato</th>
                                                <th className="py-2 px-3 text-left text-xs font-semibold text-primary-dark">Cliente</th>
                                                <th className="py-2 px-3 text-left text-xs font-semibold text-primary-dark">Valor Financiado</th>
                                                <th className="py-2 px-3 text-left text-xs font-semibold text-primary-dark">Comissão Fornecedor</th>
                                                <th className="py-2 px-3 text-left text-xs font-semibold text-primary-dark">Data Início</th>
                                                <th className="py-2 px-3 text-left text-xs font-semibold text-primary-dark">Estado</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {reportData.credits.map(credit => (
                                                <tr key={credit.id_contrato} className="border-b border-gray-200 hover:bg-gray-50">
                                                    <td className="py-2 px-3 text-sm text-gray-700">{credit.id_contrato}</td>
                                                    <td className="py-2 px-3 text-sm text-gray-700">{credit.nome_cliente}</td>
                                                    <td className="py-2 px-3 text-sm text-gray-700">{credit.valor_financiado?.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' })}</td>
                                                    <td className="py-2 px-3 text-sm text-gray-700">{credit.comissao_fornecedor?.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' })}</td>
                                                    <td className="py-2 px-3 text-sm text-gray-700">{credit.data_inicio}</td>
                                                    <td className="py-2 px-3 text-sm text-gray-700">{credit.estado}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            ) : (
                                <p className="text-gray-600 mb-6">Nenhum crédito encontrado para este fornecedor no mês selecionado.</p>
                            )}

                            <div className="text-right text-lg font-bold text-gray-800 mt-6">
                                <p>Total Comissão (sem IVA): {reportData.totalComissao.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' })}</p>
                                <p className="text-primary-dark text-2xl">Total Comissão (com IVA 23%): {reportData.totalComissaoComIVA.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' })}</p>
                            </div>

                            <div className="flex justify-end mt-6">
                                <button
                                    onClick={printReport}
                                    className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105"
                                >
                                    Imprimir Relatório (Gerar PDF)
                                </button>
                            </div>
                        </div>
                    )}
                </section>
            );
        };


        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
